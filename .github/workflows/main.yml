name: IPTV Hunter

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: Run IPTV Hunter script
        run: |
          python3 - << 'PYSCRIPT'
          import requests
          import re
          import json
          import os
          from datetime import datetime
          from bs4 import BeautifulSoup

          print("=== IPTV Hunter Starting ===")

          def search_github():
              print("Searching GitHub sources...")
              urls = []
              try:
                  query = "site:raw.githubusercontent.com iptv m3u"
                  url = "https://html.duckduckgo.com/html/?q=" + query.replace(" ", "+")
                  headers = {"User-Agent": "Mozilla/5.0"}
                  response = requests.get(url, headers=headers, timeout=30)
                  soup = BeautifulSoup(response.text, "html.parser")
                  
                  for link in soup.find_all("a", href=True):
                      href = link["href"]
                      if "raw.githubusercontent.com" in href and ".m3u" in href:
                          urls.append(href)
                  
                  print("Found", len(urls), "URLs")
              except Exception as e:
                  print("Search error:", str(e))
              
              return list(set(urls))[:30]

          def check_stream(url):
              try:
                  r = requests.get(url, timeout=8, headers={"User-Agent": "VLC/3.0"})
                  return r.status_code == 200 and len(r.content) > 100
              except:
                  return False

          def parse_m3u(url):
              try:
                  r = requests.get(url, timeout=15, headers={"User-Agent": "Mozilla/5.0"})
                  content = r.text
                  
                  if "#EXTM3U" not in content:
                      return []
                  
                  channels = []
                  lines = content.splitlines()
                  current = None
                  
                  for line in lines:
                      line = line.strip()
                      if line.startswith("#EXTINF:"):
                          name = line.split(",")[-1].strip() if "," in line else "Unknown"
                          country = "INT"
                          low = line.lower()
                          if any(x in low for x in ["ru", "russia", "—Ä–æ—Å—Å–∏—è"]): country = "RU"
                          elif any(x in low for x in ["us", "usa", "america"]): country = "US"
                          elif any(x in low for x in ["uk", "british", "england"]): country = "UK"
                          elif any(x in low for x in ["de", "germany"]): country = "DE"
                          elif any(x in low for x in ["fr", "france"]): country = "FR"
                          
                          current = {"name": name, "country": country}
                      elif line.startswith("http") and current:
                          current["url"] = line
                          if check_stream(line):
                              channels.append(current)
                          current = None
                  
                  return channels
              except Exception as e:
                  print("Parse error for", url, ":", str(e))
                  return []

          # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ main ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          urls = search_github()
          all_channels = []

          for url in urls:
              print("Processing:", url[:70] + "..." if len(url) > 70 else url)
              ch = parse_m3u(url)
              if len(ch) > 2:
                  print("  Valid channels:", len(ch))
                  all_channels.extend(ch)

          # deduplicate
          seen = set()
          unique = []
          for ch in all_channels:
              if ch["url"] not in seen:
                  seen.add(ch["url"])
                  unique.append(ch)

          print("Total unique channels:", len(unique))

          # group by country
          by_country = {}
          for ch in unique:
              c = ch.get("country", "INT")
              by_country.setdefault(c, []).append(ch)

          os.makedirs("playlists", exist_ok=True)

          for country, channels in by_country.items():
              filename = f"playlists/iptv_{country.lower()}.m3u"
              with open(filename, "w", encoding="utf-8") as f:
                  f.write("#EXTM3U\n")
                  for ch in channels:
                      f.write(f"#EXTINF:-1,{ch['name']}\n")
                      f.write(f"{ch['url']}\n")
              print("Saved:", filename, "-", len(channels), "channels")

          total = len(unique)
          now = datetime.utcnow().strftime("%d.%m.%Y %H:%M")

          # index.html
          index_html = """<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IPTV Aggregator</title>
<style>
body {margin:0;padding:20px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:white;}
.container {max-width:900px;margin:0 auto;background:rgba(255,255,255,0.95);padding:30px;border-radius:20px;color:#333;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3);}
h1 {color:#667eea;margin-bottom:10px;}
.stats {font-size:24px;margin:20px 0;color:#764ba2;font-weight:bold;}
.iframe-box {width:100%;height:400px;border:3px solid #667eea;border-radius:10px;margin:20px 0;background:#f5f5f5;}
.btn {display:inline-block;padding:15px 30px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;text-decoration:none;border-radius:25px;font-weight:bold;margin-top:20px;transition:transform 0.2s;}
.btn:hover {transform:scale(1.05);}
.update {margin-top:20px;color:#999;font-size:14px;}
</style>
</head>
<body>
<div class="container">
<h1>üåç IPTV Aggregator</h1>
<div class="stats">üì∫ """ + str(total) + """ –∫–∞–Ω–∞–ª–æ–≤ | üåê """ + str(len(by_country)) + """ —Å—Ç—Ä–∞–Ω</div>
<iframe class="iframe-box" src="full.html" frameborder="0"></iframe>
<br>
<a href="full.html" class="btn">üîó –û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é —Å–∞–π—Ç–∞</a>
<div class="update">–û–±–Ω–æ–≤–ª–µ–Ω–æ: """ + now + """ UTC | GitHub Actions</div>
</div>
</body>
</html>"""

          with open("index.html", "w", encoding="utf-8") as f:
              f.write(index_html)

          # full.html
          full_html = """<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ IPTV</title>
<style>
body {margin:0;padding:20px;font-family:Arial;background:#1a1a2e;color:white;}
.container {max-width:1200px;margin:0 auto;}
.back {display:inline-block;margin-bottom:20px;color:#64ffda;text-decoration:none;}
.grid {display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;}
.card {background:#16213e;padding:20px;border-radius:15px;border:1px solid #0f3460;}
.card h2 {margin-top:0;color:#e94560;}
.count {font-size:32px;color:#64ffda;font-weight:bold;}
a.download {display:inline-block;margin-top:15px;padding:10px 20px;background:#e94560;color:white;text-decoration:none;border-radius:20px;}
.info {margin-top:40px;padding:30px;background:#16213e;border-radius:15px;line-height:1.8;}
</style>
</head>
<body>
<div class="container">
<a href="index.html" class="back">‚Üê –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
<h1>üì∫ –ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ IPTV</h1>
<div class="grid">"""

          for country in sorted(by_country):
              count = len(by_country[country])
              full_html += f"""
  <div class="card">
  <h2>{country}</h2>
  <div class="count">{count}</div>
  <p>–∫–∞–Ω–∞–ª–æ–≤</p>
  <a href="playlists/iptv_{country.lower()}.m3u" class="download" download>–°–∫–∞—á–∞—Ç—å M3U</a>
  </div>"""

          full_html += """
</div>
<div class="info">
<h2>üì± –ö–∞–∫ —Å–º–æ—Ç—Ä–µ—Ç—å</h2>
<ul>
<li><b>VLC:</b> –ú–µ–¥–∏–∞ ‚Üí –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª ‚Üí –≤—ã–±—Ä–∞—Ç—å M3U</li>
<li><b>Kodi:</b> PVR IPTV Simple Client ‚Üí –ó–∞–≥—Ä—É–∑–∏—Ç—å M3U</li>
<li><b>Android:</b> IPTV Pro, Perfect Player, Televizo</li>
<li><b>iOS:</b> VLC, nPlayer, IPTV Player</li>
<li><b>Smart TV:</b> OTT Player, SS IPTV</li>
</ul>
<p><b>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</b> """ + now + """ UTC</p>
</div>
</div>
</body>
</html>"""

          with open("full.html", "w", encoding="utf-8") as f:
              f.write(full_html)

          # meta
          meta = {
              "total": total,
              "countries": {k: len(v) for k, v in by_country.items()},
              "updated": now
          }
          with open("meta.json", "w", encoding="utf-8") as f:
              json.dump(meta, f, ensure_ascii=False, indent=2)

          print("=== Completed ===")
          PYSCRIPT

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date +%d.%m.%Y)
          TOTAL=$(python3 -c "import json; print(json.load(open('meta.json'))['total'])")
          COUNTRIES=$(python3 -c "import json; print(len(json.load(open('meta.json'))['countries']))")
          
          gh release delete latest -y --fail-silently 2>/dev/null || true
          
          gh release create latest \
            --title "IPTV $DATE" \
            --notes "üì∫ –ö–∞–Ω–∞–ª–æ–≤: $TOTAL
          üåç –°—Ç—Ä–∞–Ω: $COUNTRIES
          üìÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ: $DATE
          
          ## üì• –§–∞–π–ª—ã
          –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –≤–∞—à–µ–π —Å—Ç—Ä–∞–Ω—ã –≤ Assets –Ω–∏–∂–µ.
          
          ## üåê –û–Ω–ª–∞–π–Ω
          https://\( {{ github.repository_owner }}.github.io/ \){{ github.event.repository.name }}/
          
          ## –ü—Ä–æ—Å–º–æ—Ç—Ä
          ‚Ä¢ VLC ‚Äî –ú–µ–¥–∏–∞ ‚Üí –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª
          ‚Ä¢ Android ‚Äî IPTV Pro / Perfect Player / Televizo
          ‚Ä¢ iOS ‚Äî VLC / nPlayer
          ‚Ä¢ Smart TV ‚Äî OTT Player / SS IPTV" \
            --latest || echo "Release already exists or failed"
          
          for file in playlists/*.m3u; do
            [ -f "$file" ] && gh release upload latest "$file" --clobber || true
          done
