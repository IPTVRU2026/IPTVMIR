name: IPTV Hunter

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: Create IPTV Hunter script
        run: |
          cat > hunter.py << 'ENDSCRIPT'
          import requests
          import re
          import json
          import os
          from datetime import datetime
          from bs4 import BeautifulSoup

          print("=== IPTV Hunter Starting ===")

          def search_github():
              print("Searching GitHub sources...")
              urls = []
              try:
                  query = "site:raw.githubusercontent.com iptv m3u"
                  url = "https://html.duckduckgo.com/html/?q=" + query.replace(" ", "+")
                  headers = {"User-Agent": "Mozilla/5.0"}
                  response = requests.get(url, headers=headers, timeout=30)
                  soup = BeautifulSoup(response.text, "html.parser")
                  
                  for link in soup.find_all("a", href=True):
                      href = link["href"]
                      if "raw.githubusercontent.com" in href and ".m3u" in href:
                          urls.append(href)
                  
                  print("Found", len(urls), "URLs")
              except Exception as e:
                  print("Search error:", e)
              
              return list(set(urls))[:30]

          def check_stream(url):
              try:
                  r = requests.get(url, timeout=8, headers={"User-Agent": "VLC/3.0"})
                  return r.status_code == 200 and len(r.content) > 100
              except:
                  return False

          def parse_m3u(url):
              try:
                  r = requests.get(url, timeout=15, headers={"User-Agent": "Mozilla/5.0"})
                  content = r.text
                  
                  if "#EXTM3U" not in content:
                      return []
                  
                  channels = []
                  lines = content.split("\n")
                  current = {}
                  
                  for line in lines:
                      line = line.strip()
                      if line.startswith("#EXTINF:"):
                          name = line.split(",")[-1] if "," in line else "Unknown"
                          country = "INT"
                          low = line.lower()
                          if any(x in low for x in ["ru", "russia", "россия"]): country = "RU"
                          elif any(x in low for x in ["us", "usa", "america"]): country = "US"
                          elif any(x in low for x in ["uk", "british", "england"]): country = "UK"
                          elif any(x in low for x in ["de", "germany"]): country = "DE"
                          elif any(x in low for x in ["fr", "france"]): country = "FR"
                          
                          current = {"name": name, "country": country}
                      elif line.startswith("http") and current:
                          current["url"] = line
                          if check_stream(line):
                              channels.append(current)
                          current = {}
                  
                  return channels
              except Exception as e:
                  print("Parse error:", e)
                  return []

          urls = search_github()
          all_channels = []

          for url in urls:
              print("Processing:", url[:50])
              ch = parse_m3u(url)
              if len(ch) > 2:
                  print("  Valid channels:", len(ch))
                  all_channels.extend(ch)

          seen = set()
          unique = []
          for ch in all_channels:
              if ch["url"] not in seen:
                  seen.add(ch["url"])
                  unique.append(ch)

          print("Total unique channels:", len(unique))

          by_country = {}
          for ch in unique:
              c = ch.get("country", "INT")
              if c not in by_country:
                  by_country[c] = []
              by_country[c].append(ch)

          os.makedirs("playlists", exist_ok=True)

          for country, channels in by_country.items():
              filename = "playlists/iptv_" + country.lower() + ".m3u"
              with open(filename, "w", encoding="utf-8") as f:
                  f.write("#EXTM3U\n")
                  for ch in channels:
                      f.write("#EXTINF:-1," + ch["name"] + "\n")
                      f.write(ch["url"] + "\n")
              print("Saved:", filename, "-", len(channels), "channels")

          total = len(unique)
          now = datetime.now().strftime("%d.%m.%Y %H:%M")

          with open("index.html", "w", encoding="utf-8") as f:
              f.write("""<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>IPTV Aggregator</title>
<style>
body{margin:0;padding:20px;font-family:Arial;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;color:white}
.container{max-width:900px;margin:0 auto;background:rgba(255,255,255,0.95);padding:30px;border-radius:20px;color:#333;text-align:center}
h1{color:#667eea}.stats{font-size:24px;margin:20px 0;color:#764ba2;font-weight:bold}
.iframe-box{width:100%;height:400px;border:3px solid #667eea;border-radius:10px;margin:20px 0;background:#f5f5f5}
.btn{display:inline-block;padding:15px 30px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;text-decoration:none;border-radius:25px;font-weight:bold;margin-top:20px}
.update{margin-top:20px;color:#999;font-size:14px}
</style>
</head>
<body>
<div class="container">
<h1>IPTV Aggregator</h1>
<div class="stats">"""+str(total)+""" channels | """+str(len(by_country))+""" countries</div>
<iframe class="iframe-box" src="full.html"></iframe>
<br><a href="full.html" class="btn">Open Full Version</a>
<div class="update">Updated: """+now+""" UTC</div>
</div>
</body>
</html>""")

          with open("full.html", "w", encoding="utf-8") as f:
              f.write("""<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>IPTV Full</title>
<style>
body{margin:0;padding:20px;font-family:Arial;background:#1a1a2e;color:white}
.container{max-width:1200px;margin:0 auto}
.back{display:inline-block;margin-bottom:20px;color:#64ffda;text-decoration:none}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px}
.card{background:#16213e;padding:20px;border-radius:15px;border:1px solid #0f3460}
.count{font-size:32px;color:#64ffda;font-weight:bold}
a.download{display:inline-block;margin-top:15px;padding:10px 20px;background:#e94560;color:white;text-decoration:none;border-radius:20px}
</style>
</head>
<body>
<div class="container">
<a href="index.html" class="back">Back</a>
<h1>IPTV Catalog</h1>
<div class="grid">""")
              
              for country in sorted(by_country.keys()):
                  count = len(by_country[country])
                  f.write('<div class="card"><h2>'+country+'</h2><div class="count">'+str(count)+'</div><p>channels</p><a href="playlists/iptv_'+country.lower()+'.m3u" class="download" download>Download M3U</a></div>')
              
              f.write("""</div>
<div style="margin-top:40px;padding:30px;background:#16213e;border-radius:15px">
<h2>How to watch</h2>
<ul>
<li>VLC: Media -> Open File</li>
<li>Android: IPTV Pro, Perfect Player</li>
<li>iOS: VLC</li>
<li>Smart TV: OTT Player</li>
</ul>
<p>Updated: """+now+""" UTC</p>
</div>
</div>
</body>
</html>""")

          meta = {"total": total, "countries": len(by_country), "updated": now}
          with open("meta.json", "w") as f:
              json.dump(meta, f)

          print("=== Completed ===")
          ENDSCRIPT

      - name: Run IPTV Hunter
        run: python hunter.py

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Delete old release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release delete latest -y || true
        continue-on-error: true

      - name: Create new release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date +%d.%m.%Y)
          TOTAL=$(python3 -c "import json; print(json.load(open('meta.json'))['total'])")
          COUNTRIES=$(python3 -c "import json; print(json.load(open('meta.json'))['countries'])")
          gh release create latest --title "IPTV $DATE" --notes "Channels: $TOTAL | Countries: $COUNTRIES | Date: $DATE" --latest

      - name: Upload files to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for file in playlists/*.m3u; do
            if [ -f "$file" ]; then
              gh release upload latest "$file" --clobber
            fi
          done
