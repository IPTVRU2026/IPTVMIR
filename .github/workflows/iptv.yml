name: IPTV Hunter

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests beautifulsoup4

      - name: Run IPTV Hunter
        run: python iptv_hunter.py

      - name: Create ZIP archive
        run: |
          if [ -d "playlists" ]; then
            zip -r iptv-playlists.zip playlists/ index.html full.html metadata.json
            echo "‚úÖ Archive created"
            ls -lh iptv-playlists.zip
          fi

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

      - name: Create Release with details
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read metadata safely
          if [ -f "metadata.json" ]; then
            TOTAL=$(python3 -c "import json; data=json.load(open('metadata.json')); print(data.get('total', 0))")
            COUNTRIES=$(python3 -c "import json; data=json.load(open('metadata.json')); print(len(data.get('countries', {})))")
          else
            TOTAL="0"
            COUNTRIES="0"
          fi
          
          DATE=$(date +%d.%m.%Y)
          
          # Detailed release notes
          NOTES="## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±–æ—Ä–∫–∏
          - **–í—Å–µ–≥–æ –∫–∞–Ω–∞–ª–æ–≤:** $TOTAL
          - **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω:** $COUNTRIES
          - **–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** $DATE
          
          ## üì• –°–∫–∞—á–∞—Ç—å
          - **üì¶ –í—Å–µ –ø–ª–µ–π–ª–∏—Å—Ç—ã (ZIP):** —Å–∫–∞—á–∞–π—Ç–µ –∞—Ä—Ö–∏–≤ –Ω–∏–∂–µ
          - **üåê –û–Ω–ª–∞–π–Ω –ø—Ä–æ—Å–º–æ—Ç—Ä:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
          - **–û—Ç–¥–µ–ª—å–Ω—ã–µ M3U:** —Ñ–∞–π–ª—ã –ø–æ —Å—Ç—Ä–∞–Ω–∞–º –≤ —Å–ø–∏—Å–∫–µ –∞–∫—Ç–∏–≤–æ–≤
          
          ## üì± –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
          1. **–°–∫–∞—á–∞–π—Ç–µ** —Ñ–∞–π–ª –≤–∞—à–µ–π —Å—Ç—Ä–∞–Ω—ã (RU, US, UK –∏ —Ç.–¥.) –∏–ª–∏ ZIP –∞—Ä—Ö–∏–≤
          2. **VLC Player:** –ú–µ–¥–∏–∞ ‚Üí –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ M3U (EPG –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
          3. **Android:** IPTV Pro, Perfect Player, Televizo
          4. **iOS:** VLC, nPlayer
          5. **Smart TV:** OTT Player, SS IPTV
          
          ## ‚öôÔ∏è –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ
          - ‚úÖ –ì—Ä—É–ø–ø—ã –∫–∞–Ω–∞–ª–æ–≤ (News, Sports, Movies –∏ —Ç.–¥.)
          - ‚úÖ EPG (–¢–µ–ª–µ–ø—Ä–æ–≥—Ä–∞–º–º–∞/—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ)
          - ‚úÖ –õ–æ–≥–æ—Ç–∏–ø—ã –∫–∞–Ω–∞–ª–æ–≤ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã)
          - ‚úÖ –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
          
          *–°–æ–∑–¥–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ GitHub Actions*"
          
          # Delete old release if exists
          gh release delete latest -y 2>/dev/null || true
          
          # Create new release
          gh release create latest \
            --title "üåç IPTV Update $DATE - $TOTAL channels" \
            --notes "$NOTES" \
            --latest
          
          # Upload ZIP
          if [ -f "iptv-playlists.zip" ]; then
            gh release upload latest iptv-playlists.zip --clobber
          fi
          
          # Upload individual M3U files
          for f in playlists/*.m3u; do
            if [ -f "$f" ]; then
              gh release upload latest "$f" --clobber || true
            fi
          done
