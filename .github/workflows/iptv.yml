name: IPTV Hunter

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests beautifulsoup4

      - name: Run IPTV Hunter
        id: hunter
        run: |
          python iptv_hunter.py
          if [ ! -f "metadata.json" ]; then
            echo "âŒ Error: metadata.json not created!"
            exit 1
          fi
          if [ ! -d "playlists" ]; then
            echo "âŒ Error: playlists folder not created!"
            exit 1
          fi

      - name: Create ZIP archive
        run: |
          if [ -d "playlists" ] && [ "$(ls -A playlists)" ]; then
            zip -r iptv-playlists.zip playlists/ index.html full.html metadata.json
            echo "âœ… Archive created with $(ls playlists | wc -l) playlists"
            ls -lh iptv-playlists.zip
          else
            echo "âŒ No playlists to archive!"
            exit 1
          fi

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Create Release
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read metadata safely
          TOTAL=$(python3 -c "import json; data=json.load(open('metadata.json')); print(data.get('total', 0))")
          COUNTRIES=$(python3 -c "import json; data=json.load(open('metadata.json')); print(len(data.get('countries', {})))")
          DATE=$(date +%d.%m.%Y)
          
          echo "Creating release with $TOTAL channels from $COUNTRIES countries"
          
          # Delete old release
          gh release delete latest -y 2>/dev/null || echo "No previous release"
          
          # Create release with proper formatting
          gh release create latest \
            --title "ğŸŒ IPTV Update $DATE - $TOTAL channels" \
            --notes "$(cat << 'EOF'
          ## ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° ÑĞ±Ğ¾Ñ€ĞºĞ¸
          - **Ğ’ÑĞµĞ³Ğ¾ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²:** '${TOTAL}'
          - **ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑÑ‚Ñ€Ğ°Ğ½:** '${COUNTRIES}'
          - **Ğ”Ğ°Ñ‚Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ:** '${DATE}'
          
          ## ğŸ“¥ Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ
          | Ğ¤Ğ°Ğ¹Ğ» | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
          |------|----------|
          | ğŸ“¦ [iptv-playlists.zip](https://github.com/${{ github.repository }}/releases/download/latest/iptv-playlists.zip) | Ğ’ÑĞµ Ğ¿Ğ»ĞµĞ¹Ğ»Ğ¸ÑÑ‚Ñ‹ Ğ² Ğ°Ñ€Ñ…Ğ¸Ğ²Ğµ |
          | ğŸŒ [ĞĞ½Ğ»Ğ°Ğ¹Ğ½ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/) | Ğ’ĞµĞ±-Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ñ iframe |
          
          ## ğŸ“± ĞšĞ°Ğº Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ
          1. **Ğ¡ĞºĞ°Ñ‡Ğ°Ğ¹Ñ‚Ğµ** Ñ„Ğ°Ğ¹Ğ» Ğ²Ğ°ÑˆĞµĞ¹ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹ (RU, US, UK Ğ¸ Ñ‚.Ğ´.) Ğ¸Ğ»Ğ¸ ZIP Ğ°Ñ€Ñ…Ğ¸Ğ²
          2. **VLC Player:** ĞœĞµĞ´Ğ¸Ğ° â†’ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ» â†’ Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ M3U
          3. **Android:** IPTV Pro, Perfect Player, Televizo
          4. **iOS:** VLC, nPlayer
          5. **Smart TV:** OTT Player, SS IPTV
          
          ## âš™ï¸ Ğ§Ñ‚Ğ¾ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾
          - âœ… Ğ“Ñ€ÑƒĞ¿Ğ¿Ñ‹ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² (News, Sports, Movies Ğ¸ Ñ‚.Ğ´.)
          - âœ… EPG (Ğ¢ĞµĞ»ĞµĞ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°/Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ)
          - âœ… Ğ›Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿Ñ‹ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² (ĞµÑĞ»Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹)
          - âœ… ĞĞ²Ñ‚Ğ¾-Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 6 Ñ‡Ğ°ÑĞ¾Ğ²
          
          *Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ñ‡ĞµÑ€ĞµĞ· GitHub Actions*
          EOF
          )" \
            --latest
          
          # Upload ZIP if exists
          if [ -f "iptv-playlists.zip" ]; then
            gh release upload latest iptv-playlists.zip --clobber || echo "ZIP upload failed"
          fi
          
          # Upload individual M3U files
          for f in playlists/*.m3u; do
            if [ -f "$f" ]; then
              echo "Uploading $f..."
              gh release upload latest "$f" --clobber || true
            fi
          done
          
          echo "âœ… Release created successfully!"

      - name: Cleanup on failure
        if: failure()
        run: |
          echo "âš ï¸ Workflow failed! Cleaning up..."
          # Logic to handle partial failures if needed
