name: IPTV Hunter

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  hunt:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install
      run: pip install requests beautifulsoup4
    
    - name: Create hunter script
      run: |
        cat > hunter.py << 'PYEOF'
import requests
import json
import os
from datetime import datetime
from bs4 import BeautifulSoup

def find_sources():
    urls = []
    try:
        r = requests.get(
            "https://html.duckduckgo.com/html/?q=site:raw.githubusercontent.com+iptv+m3u",
            headers={"User-Agent": "Mozilla/5.0"},
            timeout=30
        )
        soup = BeautifulSoup(r.text, "html.parser")
        for a in soup.find_all("a", href=True):
            h = a["href"]
            if "raw.githubusercontent.com" in h and ".m3u" in h:
                if "/blob/" in h:
                    u = h.replace("/blob/", "/").split("?")[0]
                else:
                    u = h.split("?")[0]
                urls.append(u)
        return list(set(urls))[:25]
    except:
        return []

def parse_m3u(url):
    try:
        r = requests.get(url, timeout=15, headers={"User-Agent": "VLC/3.0"})
        if "#EXTM3U" not in r.text:
            return []
        lines = r.text.splitlines()
        chs = []
        cur = {}
        for line in lines:
            line = line.strip()
            if line.startswith("#EXTINF:"):
                if "," in line:
                    name = line.split(",")[-1]
                else:
                    name = "Channel"
                country = "INT"
                if "ru" in name.lower() or "russia" in name.lower():
                    country = "RU"
                elif "us" in name.lower() or "usa" in name.lower():
                    country = "US"
                elif "uk" in name.lower():
                    country = "UK"
                cur = {"name": name, "country": country}
            elif line.startswith("http") and cur:
                cur["url"] = line
                chs.append(cur)
                cur = {}
        return chs
    except:
        return []

print("IPTV Hunter starting...")
sources = find_sources()
print(f"Found {len(sources)} sources")

all_channels = []
for i, url in enumerate(sources):
    print(f"Parsing {i+1}/{len(sources)}")
    all_channels.extend(parse_m3u(url))

print(f"Total channels: {len(all_channels)}")

seen_urls = set()
unique = [c for c in all_channels if c["url"] not in seen_urls and not seen_urls.add(c["url"])]

by_country = {}
for c in unique:
    co = c.get("country", "INT")
    if co not in by_country:
        by_country[co] = []
    by_country[co].append(c)

os.makedirs("playlists", exist_ok=True)
for country, chans in by_country.items():
    path = f"playlists/{country}.m3u"
    with open(path, "w", encoding="utf-8") as f:
        f.write("#EXTM3U\n")
        for c in chans:
            name = c["name"].replace(",", "")
            f.write(f"#EXTINF:-1,{name}\n")
            f.write(f"{c['url']}\n")
    print(f"Created {path} ({len(chans)} ch)")

total = len(unique)
now = datetime.now().strftime("%d.%m.%Y %H:%M")

html = f'''<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<title>IPTV - {total} Channels</title>
<style>body{{font-family:Arial;background:#667eea;color:white;padding:40px;text-align:center;}}
h1{{margin-bottom:20px;}} .btn{{padding:15px 30px;background:#764ba2;color:white;text-decoration:none;border-radius:25px;margin:10px;display:inline-block;}}
.stats{{font-size:1.5em;margin:20px 0;}}</style></head>
<body><h1>IPTV Aggregator</h1>
<div class="stats">{total} Channels | {len(by_country)} Countries</div>
<a href="full.html" class="btn">View Playlists</a>
<a href="iptv.zip" class="btn" download>Download ZIP</a>
<p>Updated: {now}</p></body></html>'''

with open("index.html", "w", encoding="utf-8") as f:
    f.write(html)

full_html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Playlists</title><style>body{{background:#1a1a2e;color:white;font-family:Arial;padding:20px;}}h1{{text-align:center;}}.grid{{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;margin-top:20px;}}.card{{background:#2d3748;padding:20px;border-radius:12px;text-align:center;}}.flag{{font-size:2em;}}a{{color:#4fd1c7;padding:12px 24px;border:1px solid #4fd1c7;border-radius:25px;display:block;margin-top:10px;text-decoration:none;}}:hover{{background:#4fd1c7;color:#1a1a2e;}}</style></head><body><a href="index.html" style="color:#4fd1c7;">‚Üê Home</a><h1>All Playlists</h1><div class="grid">'
flags = {"RU": "üá∑üá∫", "US": "üá∫üá∏", "UK": "üá¨üáß", "INT": "üåç"}
for c, chs in by_country.items():
    flag = flags.get(c, "üì∫")
    full_html += f'<div class="card"><div class="flag">{flag}</div><h2>{c}</h2><p>{len(chs)} channels</p><a href="playlists/{c}.m3u" download>Download {c}.m3u</a></div>'
full_html += '</div></body></html>'

with open("full.html", "w", encoding="utf-8") as f:
    f.write(full_html)

meta = {"total": total, "countries": len(by_country), "time": now}
with open("meta.json", "w") as f:
    json.dump(meta, f)

print(f"DONE: {total} channels from {len(by_country)} countries")
PYEOF

    - name: Run hunter
      run: python hunter.py
    
    - name: Archive
      run: |
        if [ -d playlists ]; then
          zip -r iptv.zip playlists/
          ls -la iptv.zip
        fi
    
    - name: Pages setup
      uses: actions/configure-pages@v5
    
    - name: Upload pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: Deploy pages
      uses: actions/deploy-pages@v4
    
    - name: Release
      if: always()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if [ -f meta.json ]; then
          TOTAL=$(python -c "import json;print(json.load(open('meta.json'))['total'])")
        else
          TOTAL=0
        fi
        DATE=$(date +%d.%m.%Y)
        
        gh release delete latest -y || true
        gh release create latest \
          --title "IPTV Update $DATE ($TOTAL ch)" \
          --notes "Channels: $TOTAL | $(date)" \
          iptv.zip *.html *.json || true
          
        for f in playlists/*.m3u; do
          [ -f "$f" ] && gh release upload latest "$f" --clobber || true
        done
        
        echo "Release done"
