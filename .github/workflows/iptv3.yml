name: IPTV Website Auto-Update

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Player Page
        run: |
          # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–ª–∏–∑–æ–≤
          cat <<EOF > full.html
          <!DOCTYPE html>
          <html lang="ru">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>IPTV MIR Player</title>
              <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
              <style>
                  body { background: #000; color: #0f0; font-family: sans-serif; margin: 0; }
                  .vjs-matrix { width: 100vw; height: 60vh; }
                  #ch-list { height: 40vh; overflow-y: auto; background: #111; padding: 10px; }
                  .channel { padding: 12px; border-bottom: 1px solid #222; cursor: pointer; }
                  .channel:hover { background: #222; }
              </style>
          </head>
          <body>
              <video id="iptv-player" class="video-js vjs-default-skin vjs-matrix" controls preload="auto"></video>
              <div id="ch-list">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–Ω–∞–ª–æ–≤...</div>
              
              <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
              <script>
                  const player = videojs('iptv-player');
                  // –ß–∏—Ç–∞–µ–º –ø–ª–µ–π–ª–∏—Å—Ç –ü–†–Ø–ú–û –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
                  async function init() {
                      try {
                          const res = await fetch('playlist.m3u?v=' + Date.now());
                          const text = await res.text();
                          const list = document.getElementById('ch-list');
                          list.innerHTML = '';
                          let name = '';
                          text.split('\n').forEach(line => {
                              if (line.includes('#EXTINF:')) name = line.split(',').pop();
                              else if (line.startsWith('http')) {
                                  const d = document.createElement('div');
                                  d.className = 'channel';
                                  d.innerText = 'üì∫ ' + (name || '–ö–∞–Ω–∞–ª');
                                  d.onclick = () => {
                                      player.src({ src: line.trim(), type: 'application/x-mpegURL' });
                                      player.play();
                                  };
                                  list.appendChild(d);
                              }
                          });
                      } catch (e) { document.getElementById('ch-list').innerText = '–û—à–∏–±–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞'; }
                  }
                  init();
              </script>
          </body>
          </html>
          EOF

      - name: Force Push to Branch
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add full.html
          # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç
          git commit -m "Update IPTV Player $(date)" || exit 0
          # –ü—É—à–∏–º –Ω–∞–ø—Ä—è–º—É—é –≤ –æ—Å–Ω–æ–≤–Ω—É—é –≤–µ—Ç–∫—É
          git push origin main
