name: IPTV IO Global Update

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build IPTV Page
        run: |
          # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
          cat <<EOF > full.html
          <!DOCTYPE html>
          <html lang="ru">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>IPTV MIR LIVE</title>
              <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
              <style>
                  body { background: #000; color: #0f0; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
                  .player-box { flex: 2; background: #000; display: flex; justify-content: center; align-items: center; }
                  .video-js { width: 100% !important; height: 100% !important; }
                  #list { flex: 1; background: #111; overflow-y: auto; padding: 10px; border-top: 2px solid #222; }
                  .item { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; display: flex; justify-content: space-between; }
                  .item:hover { background: #222; }
                  .time { font-size: 10px; color: #555; text-align: center; padding: 5px; }
              </style>
          </head>
          <body>
              <div class="player-box">
                  <video id="tv-player" class="video-js vjs-default-skin" controls preload="auto" data-setup='{}'></video>
              </div>
              <div id="list">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–Ω–∞–ª–æ–≤...</div>
              <div class="time">Update: $(date -u) | GitHub IO</div>

              <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
              <script>
                  const player = videojs('tv-player');
                  async function init() {
                      const res = await fetch('playlist.m3u?v=' + Date.now());
                      const data = await res.text();
                      const lines = data.split('\n');
                      const list = document.getElementById('list');
                      list.innerHTML = '';
                      let currentTitle = '';
                      
                      lines.forEach(line => {
                          if (line.includes('#EXTINF:')) {
                              currentTitle = line.split(',').pop().trim();
                          } else if (line.startsWith('http')) {
                              const url = line.trim();
                              const el = document.createElement('div');
                              el.className = 'item';
                              el.innerHTML = '<span>üì∫ ' + currentTitle + '</span><span>‚ñ∂</span>';
                              el.onclick = () => {
                                  player.src({ src: url, type: 'application/x-mpegURL' });
                                  player.play();
                              };
                              list.appendChild(el);
                          }
                      });
                  }
                  init();
              </script>
          </body>
          </html>
          EOF

      - name: Commit files
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add full.html
          git commit -m "Deploy to GitHub Pages: $(date)" || echo "No changes"
          git push origin main

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
