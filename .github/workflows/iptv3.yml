name: Update IPTV Live

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate full.html
        run: |
          cat <<EOF > full.html
          <!DOCTYPE html>
          <html lang="ru">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>IPTV Плеер 2026</title>
              <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
              <style>
                  body { background: #0f0f0f; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
                  header { padding: 10px; background: #1a1a1a; text-align: center; border-bottom: 2px solid #333; }
                  .main-layout { display: flex; flex: 1; overflow: hidden; }
                  #playlist { width: 300px; background: #141414; overflow-y: auto; border-right: 1px solid #333; padding: 10px; }
                  .player-container { flex: 1; display: flex; flex-direction: column; justify-content: center; background: #000; padding: 20px; }
                  .video-js { width: 100%; height: 500px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
                  .ch-item { padding: 12px; margin-bottom: 5px; background: #222; border-radius: 5px; cursor: pointer; transition: 0.2s; font-size: 14px; }
                  .ch-item:hover { background: #333; border-left: 4px solid #00ff00; }
                  .footer-info { font-size: 11px; color: #555; padding: 5px; text-align: center; }
                  @media (max-width: 768px) { .main-layout { flex-direction: column; } #playlist { width: 100%; height: 200px; } }
              </style>
          </head>
          <body>
              <header>
                  <strong>IPTV MIR PLAYER</strong>
              </header>
              <div class="main-layout">
                  <div id="playlist">Загрузка каналов...</div>
                  <div class="player-container">
                      <video id="v-player" class="video-js vjs-default-skin vjs-big-play-centered" controls preload="auto"></video>
                      <div class="footer-info">Обновлено: $(date -u +'%d.%m.%Y %H:%M') UTC</div>
                  </div>
              </div>

              <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
              <script>
                  const player = videojs('v-player');
                  // Ссылка на ваш m3u файл в репозитории (укажите точное имя файла!)
                  const m3uUrl = 'https://raw.githubusercontent.com/${{ github.repository }}/main/playlist.m3u';

                  async function init() {
                      try {
                          const res = await fetch(m3uUrl);
                          const text = await res.text();
                          const lines = text.split('\n');
                          const list = document.getElementById('playlist');
                          list.innerHTML = '';
                          
                          let name = '';
                          lines.forEach(line => {
                              if (line.includes('#EXTINF:')) {
                                  name = line.split(',').pop().trim();
                              } else if (line.startsWith('http')) {
                                  const url = line.trim();
                                  const div = document.createElement('div');
                                  div.className = 'ch-item';
                                  div.innerText = name || 'Канал без названия';
                                  div.onclick = () => {
                                      player.src({ src: url, type: 'application/x-mpegURL' });
                                      player.play();
                                  };
                                  list.appendChild(div);
                                  name = '';
                              }
                          });
                      } catch (e) {
                          document.getElementById('playlist').innerText = 'Ошибка плейлиста. Проверьте файл playlist.m3u';
                      }
                  }
                  init();
              </script>
          </body>
          </html>
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add full.html
          git commit -m "Update full.html: $(date)" || echo "Nothing to update"
          git push origin main
