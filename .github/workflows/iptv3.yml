name: Ultimate IPTV Update

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl git
          # Здесь можно добавить установку python/node, если появятся сложные скрипты

      - name: Generate full.html (Force Update)
        run: |
          # Генерируем HTML с уникальным ID версии для обхода кэша
          VERSION_ID=$(date +%s)
          cat <<EOF > full.html
          <!DOCTYPE html>
          <html lang="ru">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>IPTV Player Ultra</title>
              <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
              <style>
                  body { background: #050505; color: #00ff00; font-family: monospace; margin: 0; padding: 10px; }
                  .container { max-width: 1200px; margin: auto; border: 1px solid #333; }
                  .vjs-matrix { width: 100%; height: 500px; }
                  #playlist-box { background: #111; height: 300px; overflow-y: auto; padding: 10px; border-top: 1px solid #333; }
                  .chan { padding: 8px; border-bottom: 1px solid #222; cursor: pointer; color: #aaa; }
                  .chan:hover { color: #fff; background: #222; }
                  .meta { font-size: 10px; color: #444; text-align: right; padding: 5px; }
              </style>
          </head>
          <body>
              <div class="container">
                  <video id="iptv-vjs" class="video-js vjs-default-skin vjs-big-play-centered vjs-matrix" controls preload="auto"></video>
                  <div id="playlist-box">Загрузка каналов из репозитория...</div>
                  <div class="meta">Версия сборки: $VERSION_ID | Обновлено: $(date)</div>
              </div>
              <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
              <script>
                  const player = videojs('iptv-vjs');
                  // Пытаемся найти плейлист по всем возможным путям
                  const paths = ['playlist.m3u', 'channels.m3u', 'list.m3u'];
                  
                  async function loadFirstAvailable() {
                      const box = document.getElementById('playlist-box');
                      for (let path of paths) {
                          try {
                              const r = await fetch(path + '?v=$VERSION_ID');
                              if (!r.ok) continue;
                              const text = await r.text();
                              parseM3U(text);
                              return;
                          } catch (e) {}
                      }
                      box.innerText = 'Файл плейлиста не найден в корне репозитория.';
                  }

                  function parseM3U(data) {
                      const box = document.getElementById('playlist-box');
                      box.innerHTML = '';
                      const lines = data.split('\n');
                      let name = '';
                      lines.forEach(l => {
                          if (l.includes('#EXTINF:')) name = l.split(',').pop();
                          else if (l.startsWith('http')) {
                              const d = document.createElement('div');
                              d.className = 'chan';
                              d.innerText = '▶ ' + (name || 'Канал');
                              d.onclick = () => { player.src({src: l.trim(), type: 'application/x-mpegURL'}); player.play(); };
                              box.appendChild(d);
                              name = '';
                          }
                      });
                  }
                  loadFirstAvailable();
              </script>
          </body>
          </html>
          EOF

      - name: Robust Push (Retry on failure)
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add full.html
          
          # Цикл попыток пуша (если репозиторий занят или заблокирован)
          for i in {1..5}; do
            git commit -m "Force Update IPTV: $(date)" && git push origin main && break || sleep 15
          done

      - name: Force Purge Pages Cache
        run: |
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/pages/builds || echo "Pages trigger failed, but file is pushed"
