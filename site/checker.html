<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>INDEX33 ‚Äî IPTV Checker</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Exo+2:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.14/dist/hls.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INDEX33 ‚Äî IPTV CHECKER
   Aesthetic: Military-grade terminal meets
   cinematic HUD. Amber + cyan on deep black.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root {
  --black: #000;
  --bg:    #04060a;
  --bg1:   #070b11;
  --bg2:   #0b1018;
  --bg3:   #101620;
  --bg4:   #141c28;

  --amber:  #ffb700;
  --amber2: #ff8c00;
  --cyan:   #00e5ff;
  --cyan2:  #0099bb;
  --green:  #39ff14;
  --red:    #ff2244;
  --purple: #c044ff;

  --txt:    #d4dde8;
  --txt2:   #637080;
  --txt3:   #2a3848;

  --mono: 'Share Tech Mono', monospace;
  --head: 'Exo 2', sans-serif;

  --r: 4px;
  --r2: 8px;

  --ga: 0 0 12px rgba(255,183,0,.4), 0 0 30px rgba(255,183,0,.15);
  --gc: 0 0 12px rgba(0,229,255,.4), 0 0 30px rgba(0,229,255,.15);
  --gg: 0 0 12px rgba(57,255,20,.4), 0 0 30px rgba(57,255,20,.15);
  --gr: 0 0 12px rgba(255,34,68,.4), 0 0 30px rgba(255,34,68,.15);
}

html { font-size: 13px; scroll-behavior: smooth; }

body {
  font-family: var(--mono);
  background: var(--bg);
  color: var(--txt);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
}

/* grid background */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image:
    linear-gradient(rgba(0,229,255,.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,229,255,.025) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none; z-index: 0;
}

/* scan lines */
body::after {
  content: '';
  position: fixed; inset: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent, transparent 2px,
    rgba(0,0,0,.06) 2px, rgba(0,0,0,.06) 4px
  );
  pointer-events: none; z-index: 0;
}

/* ‚ïê‚ïê HEADER ‚ïê‚ïê */
header {
  position: sticky; top: 0; z-index: 200;
  background: rgba(4,6,10,.96);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(0,229,255,.15);
  height: 56px;
  display: flex; align-items: center;
  padding: 0 16px; gap: 12px;
}

.logo-mark {
  font-family: var(--head);
  font-weight: 900;
  font-size: 22px;
  letter-spacing: 3px;
  color: var(--amber);
  text-shadow: var(--ga);
  flex-shrink: 0;
  line-height: 1;
}

.logo-mark sup {
  font-size: 10px;
  color: var(--cyan);
  letter-spacing: 1px;
  vertical-align: super;
  text-shadow: var(--gc);
}

.hdr-sep { width: 1px; height: 28px; background: var(--bg4); flex-shrink: 0; }

.hdr-nav {
  display: flex; gap: 2px;
  overflow-x: auto; flex: 1;
}

.hdr-tab {
  padding: 6px 14px;
  font-family: var(--mono);
  font-size: 11px;
  letter-spacing: 1px;
  color: var(--txt2);
  background: none; border: none;
  border-radius: var(--r);
  cursor: pointer;
  white-space: nowrap;
  transition: all .2s;
  text-transform: uppercase;
}

.hdr-tab:hover { color: var(--txt); background: var(--bg3); }
.hdr-tab.on { color: var(--amber); background: rgba(255,183,0,.08); }

.hdr-right {
  display: flex; align-items: center; gap: 10px;
  flex-shrink: 0; margin-left: auto;
}

.lang-sw {
  display: flex; gap: 2px;
  background: var(--bg2);
  border: 1px solid var(--bg4);
  border-radius: var(--r);
  padding: 2px;
}

.lang-btn {
  padding: 4px 9px;
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 1px;
  border: none; background: none;
  color: var(--txt2);
  border-radius: 2px;
  cursor: pointer;
  transition: all .15s;
}

.lang-btn.on { background: var(--amber); color: #000; }

/* ‚ïê‚ïê LAYOUT ‚ïê‚ïê */
.app {
  position: relative; z-index: 1;
  flex: 1;
  display: grid;
  grid-template-columns: 280px 1fr;
  min-height: 0;
}

@media(max-width:768px) {
  .app { grid-template-columns: 1fr; }
  .sidebar { position: static !important; height: auto !important; }
}

/* ‚ïê‚ïê SIDEBAR ‚ïê‚ïê */
.sidebar {
  background: var(--bg1);
  border-right: 1px solid rgba(0,229,255,.08);
  height: calc(100vh - 56px);
  position: sticky; top: 56px;
  overflow-y: auto; overflow-x: hidden;
  display: flex; flex-direction: column;
}

.sb-section {
  border-bottom: 1px solid var(--bg3);
  padding: 14px 14px;
}

.sb-label {
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 2.5px;
  text-transform: uppercase;
  color: var(--txt3);
  margin-bottom: 10px;
  display: flex; align-items: center; gap: 6px;
}

.sb-label::after {
  content: ''; flex: 1;
  height: 1px; background: var(--bg4);
}

/* ‚ïê‚ïê FORM ‚ïê‚ïê */
.fld { display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px; }
.fld:last-child { margin-bottom: 0; }

.fld-lbl {
  font-size: 9px; letter-spacing: 1.5px;
  color: var(--txt3); text-transform: uppercase;
}

input[type=text], input[type=file], select {
  width: 100%;
  background: var(--bg2);
  border: 1px solid var(--bg4);
  border-radius: var(--r);
  color: var(--txt);
  padding: 8px 10px;
  font-family: var(--mono);
  font-size: 11px;
  outline: none;
  transition: border-color .2s, box-shadow .2s;
  appearance: none;
}

input[type=text]::placeholder { color: var(--txt3); }
input[type=text]:focus, select:focus {
  border-color: var(--cyan2);
  box-shadow: 0 0 0 2px rgba(0,229,255,.08);
}

input[type=file] { padding: 6px 10px; cursor: pointer; }
select { cursor: pointer; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23637080'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; padding-right: 28px; }

/* ‚ïê‚ïê BUTTONS ‚ïê‚ïê */
.btn {
  width: 100%;
  padding: 9px 12px;
  border: none; border-radius: var(--r);
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 7px;
  transition: all .2s;
  margin-bottom: 5px;
  position: relative;
  overflow: hidden;
}

.btn::after {
  content: '';
  position: absolute; inset: 0;
  background: rgba(255,255,255,0);
  transition: background .15s;
}

.btn:hover::after { background: rgba(255,255,255,.05); }
.btn:active { transform: scale(.98); }
.btn:disabled { opacity: .3; cursor: not-allowed; }
.btn:last-child { margin-bottom: 0; }

.btn-amber { background: rgba(255,183,0,.12); color: var(--amber); border: 1px solid rgba(255,183,0,.35); }
.btn-amber:not(:disabled):hover { box-shadow: var(--ga); }
.btn-red   { background: rgba(255,34,68,.1);  color: var(--red);   border: 1px solid rgba(255,34,68,.3); }
.btn-red:not(:disabled):hover { box-shadow: var(--gr); }
.btn-cyan  { background: rgba(0,229,255,.08); color: var(--cyan);  border: 1px solid rgba(0,229,255,.25); }
.btn-cyan:not(:disabled):hover { box-shadow: var(--gc); }
.btn-green { background: rgba(57,255,20,.08); color: var(--green); border: 1px solid rgba(57,255,20,.25); }
.btn-green:not(:disabled):hover { box-shadow: var(--gg); }
.btn-ghost { background: transparent; color: var(--txt2); border: 1px solid var(--bg4); }
.btn-ghost:not(:disabled):hover { color: var(--txt); border-color: var(--txt2); }

/* ‚ïê‚ïê SPEED PRESETS ‚ïê‚ïê */
.speed-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 5px;
  margin-bottom: 10px;
}

.spd-btn {
  padding: 8px 6px;
  border: 1px solid var(--bg4);
  border-radius: var(--r);
  background: var(--bg2);
  color: var(--txt2);
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: .5px;
  cursor: pointer;
  transition: all .2s;
  text-align: center;
  line-height: 1.4;
}

.spd-btn .spd-name { font-weight: 700; font-size: 11px; display: block; }
.spd-btn .spd-info { font-size: 9px; color: var(--txt3); display: block; margin-top: 2px; }

.spd-btn:hover { border-color: var(--amber2); color: var(--amber); }
.spd-btn.on { border-color: var(--amber); color: var(--amber); background: rgba(255,183,0,.08); box-shadow: var(--ga); }

/* ‚ïê‚ïê SPEED METER ‚ïê‚ïê */
.spd-meter { margin-top: 8px; }
.spd-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.spd-label { font-size: 9px; letter-spacing: 1.5px; color: var(--txt3); text-transform: uppercase; }
.spd-val { font-size: 14px; font-weight: 700; color: var(--amber); }
.spd-bar-bg { height: 3px; background: var(--bg3); border-radius: 2px; overflow: hidden; }
.spd-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--amber2), var(--amber)); border-radius: 2px; transition: width .4s ease; box-shadow: var(--ga); }

/* ‚ïê‚ïê MINI LIST ‚ïê‚ïê */
.mini-list { list-style: none; max-height: 120px; overflow-y: auto; }
.mini-list li {
  padding: 5px 8px; border-radius: var(--r);
  font-size: 11px; color: var(--txt2);
  cursor: pointer; overflow: hidden;
  text-overflow: ellipsis; white-space: nowrap;
  transition: background .1s, color .1s;
}
.mini-list li:hover { background: var(--bg3); color: var(--txt); }

/* ‚ïê‚ïê BLOB PANEL ‚ïê‚ïê */
.blob-panel {
  display: none;
  background: rgba(57,255,20,.05);
  border: 1px solid rgba(57,255,20,.2);
  border-radius: var(--r);
  padding: 10px;
  margin-top: 10px;
}

.blob-url {
  color: var(--green);
  font-size: 10px;
  word-break: break-all;
  line-height: 1.5;
  display: block;
  margin-bottom: 8px;
  text-decoration: none;
}

/* ‚ïê‚ïê MAIN PANEL ‚ïê‚ïê */
.main-panel {
  display: flex; flex-direction: column;
  min-height: 0; overflow: hidden;
}

/* ‚ïê‚ïê STATS + TIMER BAR ‚ïê‚ïê */
.stats-bar {
  background: var(--bg1);
  border-bottom: 1px solid rgba(0,229,255,.08);
  padding: 10px 16px;
  display: flex;
  align-items: center;
  gap: 0;
  flex-wrap: nowrap;
  overflow-x: auto;
  flex-shrink: 0;
}

.stat-item {
  display: flex; flex-direction: column;
  align-items: center;
  padding: 0 16px;
  border-right: 1px solid var(--bg3);
  flex-shrink: 0;
}

.stat-item:first-child { padding-left: 0; }
.stat-item:last-child { border-right: none; }

.stat-lbl {
  font-size: 8px; letter-spacing: 2px;
  color: var(--txt3); text-transform: uppercase;
  margin-bottom: 2px;
}

.stat-val {
  font-family: var(--head);
  font-size: 20px; font-weight: 700;
  line-height: 1;
}

.sv-total  { color: var(--cyan);  text-shadow: var(--gc); }
.sv-ok     { color: var(--green); text-shadow: var(--gg); }
.sv-dead   { color: var(--red);   text-shadow: var(--gr); }
.sv-rem    { color: var(--amber); text-shadow: var(--ga); }

/* ‚ïê‚ïê TIMER ‚ïê‚ïê */
.timer-wrap {
  margin-left: auto;
  display: flex; align-items: center; gap: 14px;
  flex-shrink: 0;
}

.timer-block {
  display: flex; flex-direction: column; align-items: flex-end;
}

.timer-label {
  font-size: 8px; letter-spacing: 2px;
  color: var(--txt3); text-transform: uppercase;
  margin-bottom: 1px;
}

.timer-digits {
  font-family: var(--head);
  font-size: 24px; font-weight: 700;
  color: var(--amber);
  text-shadow: var(--ga);
  letter-spacing: 2px;
  font-variant-numeric: tabular-nums;
  line-height: 1;
}

.eta-val {
  font-size: 10px; color: var(--txt2);
  letter-spacing: 1px;
  text-align: right;
}

/* Info button near timer */
.timer-info-btn {
  width: 30px; height: 30px;
  border-radius: 50%;
  background: rgba(0,229,255,.08);
  border: 1px solid rgba(0,229,255,.25);
  color: var(--cyan);
  font-family: var(--head);
  font-size: 13px; font-weight: 700;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .2s; flex-shrink: 0;
}

.timer-info-btn:hover { background: rgba(0,229,255,.16); box-shadow: var(--gc); }

/* ‚ïê‚ïê PROGRESS BAR ‚ïê‚ïê */
.prog-wrap {
  height: 2px; background: var(--bg3);
  flex-shrink: 0; display: none;
  position: relative;
}

.prog-fill {
  height: 100%; width: 0%;
  background: linear-gradient(90deg, var(--amber2), var(--amber), var(--cyan));
  transition: width .3s linear;
  box-shadow: 0 0 8px var(--amber);
}

/* ‚ïê‚ïê FILTER BAR ‚ïê‚ïê */
.filter-bar {
  background: var(--bg1);
  border-bottom: 1px solid rgba(0,229,255,.06);
  padding: 8px 16px;
  display: flex; gap: 8px; align-items: center;
  flex-shrink: 0; flex-wrap: wrap;
}

.filter-chip {
  padding: 5px 12px;
  border: 1px solid var(--bg4);
  border-radius: 20px;
  background: none;
  color: var(--txt2);
  font-family: var(--mono);
  font-size: 10px; letter-spacing: .5px;
  cursor: pointer; white-space: nowrap;
  transition: all .15s;
}

.filter-chip:hover { color: var(--txt); border-color: var(--txt3); }
.filter-chip.on { color: var(--amber); border-color: var(--amber); background: rgba(255,183,0,.06); }

.filter-search {
  flex: 1; min-width: 140px; max-width: 280px;
  padding: 5px 10px !important; font-size: 11px !important;
}

/* ‚ïê‚ïê CONTENT PANES ‚ïê‚ïê */
.pane { display: none; flex: 1; flex-direction: column; min-height: 0; overflow: hidden; }
.pane.on { display: flex; }

/* ‚ïê‚ïê TABLE ‚ïê‚ïê */
.tbl-scroll {
  flex: 1; overflow-y: auto; overflow-x: hidden;
  min-height: 0;
}

table { width: 100%; border-collapse: collapse; }

thead th {
  background: var(--bg2);
  padding: 8px 12px;
  font-size: 9px; font-weight: 700;
  letter-spacing: 2px; color: var(--txt3);
  text-transform: uppercase;
  text-align: left;
  position: sticky; top: 0; z-index: 2;
  border-bottom: 1px solid var(--bg3);
  white-space: nowrap;
}

tbody tr {
  border-bottom: 1px solid var(--bg2);
  transition: background .1s;
}

tbody tr:hover { background: var(--bg2); }

td {
  padding: 7px 12px; font-size: 11px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  max-width: 180px;
}

.td-logo { width: 46px; padding: 4px 12px; max-width: 46px; }
.td-actions { width: 100px; max-width: 100px; }

.ch-logo {
  width: 28px; height: 28px;
  object-fit: cover; border-radius: 3px;
  background: var(--bg2); display: block;
}

/* ‚ïê‚ïê STATUS BADGES ‚ïê‚ïê */
.badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 9px; border-radius: 3px;
  font-size: 10px; font-weight: 700; letter-spacing: .5px;
}

.b-ok  { background: rgba(57,255,20,.08); color: var(--green); border: 1px solid rgba(57,255,20,.2); }
.b-err { background: rgba(255,34,68,.08); color: var(--red);   border: 1px solid rgba(255,34,68,.2); }
.b-chk { background: rgba(255,183,0,.06); color: var(--amber); border: 1px solid rgba(255,183,0,.2); animation: blink 1s ease-in-out infinite; }

@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.4} }

/* ‚ïê‚ïê TABLE ACTION BUTTONS ‚ïê‚ïê */
.act-btns { display: flex; gap: 4px; }

.act-btn {
  width: 26px; height: 26px;
  border: none; border-radius: 3px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 12px;
  transition: all .15s; flex-shrink: 0;
}

.act-btn:hover { transform: scale(1.2); }
.ab-play { background: rgba(0,229,255,.12); color: var(--cyan); border: 1px solid rgba(0,229,255,.25); }
.ab-ext  { background: rgba(57,255,20,.08); color: var(--green); border: 1px solid rgba(57,255,20,.2); }
.ab-fav  { background: rgba(255,183,0,.08); color: var(--amber); border: 1px solid rgba(255,183,0,.2); }
.ab-fav.on { background: rgba(255,183,0,.2); }

/* ‚ïê‚ïê PAGER ‚ïê‚ïê */
.pager {
  background: var(--bg1);
  border-top: 1px solid var(--bg3);
  padding: 8px 16px;
  display: flex; align-items: center; gap: 8px;
  flex-shrink: 0; flex-wrap: wrap;
}

.pg-btn {
  padding: 5px 12px;
  background: var(--bg2); border: 1px solid var(--bg4);
  border-radius: var(--r); color: var(--txt2);
  font-family: var(--mono); font-size: 11px;
  cursor: pointer; transition: all .15s;
}

.pg-btn:hover:not(:disabled) { border-color: var(--cyan2); color: var(--cyan); }
.pg-btn:disabled { opacity: .3; cursor: not-allowed; }
.pg-info { font-size: 10px; color: var(--txt2); flex: 1; text-align: center; }
.pg-size { padding: 5px 8px; background: var(--bg2); border: 1px solid var(--bg4); border-radius: var(--r); color: var(--txt2); font-family: var(--mono); font-size: 11px; width: auto; }

/* ‚ïê‚ïê COMPARE AREA ‚ïê‚ïê */
.compare-area { padding: 16px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; }

/* ‚ïê‚ïê VIDEO MINI PLAYER ‚ïê‚ïê */
#miniPlayer {
  position: fixed;
  bottom: 20px; right: 20px;
  width: 380px;
  background: var(--bg);
  border: 1px solid var(--amber);
  border-radius: var(--r2);
  box-shadow: var(--ga), 0 20px 60px rgba(0,0,0,.8);
  z-index: 500;
  display: none;
  flex-direction: column;
  overflow: hidden;
  resize: both;
  min-width: 280px; min-height: 200px;
}

#miniPlayer.show { display: flex; }

.mini-hdr {
  background: var(--bg2);
  padding: 8px 12px;
  display: flex; align-items: center; gap: 8px;
  border-bottom: 1px solid var(--bg3);
  cursor: move;
  flex-shrink: 0;
}

.mini-title {
  font-size: 11px; color: var(--amber);
  flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}

.mini-ctrl { display: flex; gap: 5px; }

.mini-btn {
  width: 22px; height: 22px;
  border: 1px solid var(--bg4);
  border-radius: 3px; background: var(--bg3);
  color: var(--txt2); font-size: 11px;
  cursor: pointer; display: flex;
  align-items: center; justify-content: center;
  transition: all .15s;
}

.mini-btn:hover { border-color: var(--red); color: var(--red); }

#miniVideo {
  width: 100%;
  aspect-ratio: 16/9;
  background: #000;
  display: block;
}

.mini-footer {
  padding: 6px 12px;
  font-size: 10px; color: var(--txt3);
  display: flex; align-items: center; gap: 8px;
  background: var(--bg2);
  flex-shrink: 0;
}

.mini-status { flex: 1; }

.mini-status.ok   { color: var(--green); }
.mini-status.err  { color: var(--red); }
.mini-status.load { color: var(--amber); animation: blink 1s infinite; }

/* ‚ïê‚ïê FULLSCREEN VIDEO ‚ïê‚ïê */
#fullPlayer {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.95);
  z-index: 600;
  display: none;
  align-items: center; justify-content: center;
  backdrop-filter: blur(8px);
}

#fullPlayer.show { display: flex; }

.fp-box {
  position: relative;
  width: 92%; max-width: 980px;
  background: #000;
  border: 1px solid var(--amber);
  border-radius: var(--r2);
  box-shadow: var(--ga);
}

.fp-hdr {
  display: flex; align-items: center;
  padding: 8px 14px;
  background: var(--bg2);
  border-bottom: 1px solid var(--bg3);
}

.fp-title { color: var(--amber); font-size: 12px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.fp-close {
  width: 28px; height: 28px;
  background: rgba(255,34,68,.15);
  border: 1px solid rgba(255,34,68,.3);
  border-radius: 3px; color: var(--red);
  font-size: 14px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .15s;
}

.fp-close:hover { background: var(--red); color: #fff; }

#fullVideo {
  width: 100%; height: auto;
  max-height: 85vh; display: block;
}

/* ‚ïê‚ïê MODAL ‚ïê‚ïê */
#modal {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.7);
  z-index: 700;
  display: none; align-items: center; justify-content: center;
  backdrop-filter: blur(4px);
}

#modal.show { display: flex; }

.modal-box {
  background: var(--bg2);
  border: 1px solid var(--bg4);
  border-radius: var(--r2);
  padding: 28px 32px;
  max-width: 420px; width: 92%;
  text-align: center;
  animation: popIn .2s ease;
  white-space: pre-line;
}

@keyframes popIn { from{transform:scale(.87);opacity:0} to{transform:scale(1);opacity:1} }

.modal-title {
  font-family: var(--head);
  font-size: 18px; font-weight: 700;
  letter-spacing: 2px; margin-bottom: 12px;
}

.mt-ok  { color: var(--green); text-shadow: var(--gg); }
.mt-err { color: var(--red);   text-shadow: var(--gr); }
.mt-inf { color: var(--cyan);  text-shadow: var(--gc); }
.mt-amb { color: var(--amber); text-shadow: var(--ga); }

.modal-msg { font-size: 12px; color: var(--txt2); line-height: 1.7; margin-bottom: 22px; }

/* ‚ïê‚ïê INFO MODAL (timer button) ‚ïê‚ïê */
.info-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 20px;
  text-align: left;
}

.info-cell {
  background: var(--bg3);
  border: 1px solid var(--bg4);
  border-radius: var(--r);
  padding: 10px 12px;
}

.info-cell-lbl {
  font-size: 9px; letter-spacing: 1.5px;
  color: var(--txt3); text-transform: uppercase;
  margin-bottom: 4px;
}

.info-cell-val {
  font-family: var(--head);
  font-size: 18px; font-weight: 700;
}

/* ‚ïê‚ïê TEST MODAL ‚ïê‚ïê */
.test-channels { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; text-align: left; }

.test-ch-row {
  background: var(--bg3);
  border: 1px solid var(--bg4);
  border-radius: var(--r);
  padding: 8px 10px;
  display: flex; align-items: center; gap: 10px;
}

.test-ch-name { flex: 1; font-size: 11px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.test-ch-st { font-size: 10px; }

/* ‚ïê‚ïê SCROLLBAR ‚ïê‚ïê */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--bg4); border-radius: 2px; }
::-webkit-scrollbar-thumb:hover { background: var(--txt3); }

/* ‚ïê‚ïê MOBILE ‚ïê‚ïê */
@media(max-width:768px) {
  header { padding: 0 10px; }
  .logo-mark { font-size: 18px; }
  .hdr-nav { display: none; }
  .stats-bar { padding: 8px 10px; gap: 0; }
  .stat-item { padding: 0 10px; }
  .stat-val { font-size: 16px; }
  .timer-digits { font-size: 18px; }
  .filter-bar { padding: 6px 10px; }
  td { padding: 5px 8px; }
  #miniPlayer { width: calc(100vw - 20px); right: 10px; bottom: 10px; }
  .info-grid { grid-template-columns: 1fr; }
}

@media(max-width:480px) {
  .stat-item:nth-child(n+4) { display: none; }
  .timer-wrap { flex-direction: column; gap: 4px; align-items: flex-end; }
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê VIDEO: MINI PLAYER ‚ïê‚ïê -->
<div id="miniPlayer">
  <div class="mini-hdr" id="miniDragHdr">
    <span class="mini-title" id="miniTitle">‚Äî</span>
    <div class="mini-ctrl">
      <button class="mini-btn" id="miniExpand" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å">‚õ∂</button>
      <button class="mini-btn" id="miniClose" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </div>
  </div>
  <video id="miniVideo" playsinline autoplay controls crossorigin="anonymous"></video>
  <div class="mini-footer">
    <span class="mini-status load" id="miniStatus">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    <button class="mini-btn" onclick="openExtUrl(document.getElementById('miniVideo').src||'')" style="width:auto;padding:2px 8px;font-size:10px;">‚Üó EXT</button>
  </div>
</div>

<!-- ‚ïê‚ïê VIDEO: FULL PLAYER ‚ïê‚ïê -->
<div id="fullPlayer">
  <div class="fp-box">
    <div class="fp-hdr">
      <span class="fp-title" id="fpTitle">‚Äî</span>
      <button class="fp-close" id="fpClose">‚úï</button>
    </div>
    <video id="fullVideo" playsinline autoplay controls crossorigin="anonymous"></video>
  </div>
</div>

<!-- ‚ïê‚ïê MODAL ‚ïê‚ïê -->
<div id="modal">
  <div class="modal-box" id="modalBox">
    <div class="modal-title" id="modalTitle">‚Äî</div>
    <div class="modal-msg" id="modalMsg"></div>
    <div id="modalExtra"></div>
    <button class="btn btn-amber" id="modalOk" style="width:auto;padding:8px 32px;margin:0 auto">OK</button>
  </div>
</div>

<!-- ‚ïê‚ïê HEADER ‚ïê‚ïê -->
<header>
  <div class="logo-mark">INDEX<sup>33</sup></div>
  <div class="hdr-sep"></div>
  <nav class="hdr-nav">
    <button class="hdr-tab on" data-tab="results"  data-en="Results"  data-ru="–†–µ–∑—É–ª—å—Ç–∞—Ç—ã">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
    <button class="hdr-tab"   data-tab="favorites" data-en="Favorites" data-ru="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
    <button class="hdr-tab"   data-tab="compare"   data-en="Compare"   data-ru="–°—Ä–∞–≤–Ω–µ–Ω–∏–µ">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</button>
  </nav>
  <div class="hdr-right">
    <div class="lang-sw">
      <button class="lang-btn on" data-lang="ru">RU</button>
      <button class="lang-btn"    data-lang="en">EN</button>
    </div>
  </div>
</header>

<!-- ‚ïê‚ïê APP ‚ïê‚ïê -->
<div class="app">

<!-- ‚ïê‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê -->
<aside class="sidebar">

  <!-- SOURCE -->
  <div class="sb-section">
    <div class="sb-label" data-en="Source" data-ru="–ò—Å—Ç–æ—á–Ω–∏–∫">–ò—Å—Ç–æ—á–Ω–∏–∫</div>
    <div class="fld">
      <span class="fld-lbl" data-en="File (M3U/TXT/JSON)" data-ru="–§–∞–π–ª (M3U/TXT/JSON)">–§–∞–π–ª (M3U/TXT/JSON)</span>
      <input type="file" id="fileInput" accept=".m3u,.m3u8,.txt,.json">
    </div>
    <div class="fld">
      <span class="fld-lbl" data-en="Playlist URL" data-ru="URL –ø–ª–µ–π–ª–∏—Å—Ç–∞">URL –ø–ª–µ–π–ª–∏—Å—Ç–∞</span>
      <input type="text" id="m3uUrl" placeholder="https://...playlist.m3u">
    </div>
  </div>

  <!-- SPEED -->
  <div class="sb-section">
    <div class="sb-label" data-en="Speed Mode" data-ru="–†–µ–∂–∏–º —Å–∫–æ—Ä–æ—Å—Ç–∏">–†–µ–∂–∏–º —Å–∫–æ—Ä–æ—Å—Ç–∏</div>
    <div class="speed-grid">
      <button class="spd-btn" data-t="500"  data-c="200" data-key="ultra">
        <span class="spd-name">‚ö° ULTRA</span>
        <span class="spd-info" data-en="200 threads / 0.5s" data-ru="200 –ø–æ—Ç–æ–∫–æ–≤ / 0.5—Å">200 –ø–æ—Ç–æ–∫–æ–≤ / 0.5—Å</span>
      </button>
      <button class="spd-btn on" data-t="1500" data-c="100" data-key="turbo">
        <span class="spd-name">‚ö° TURBO</span>
        <span class="spd-info" data-en="100 threads / 1.5s" data-ru="100 –ø–æ—Ç–æ–∫–æ–≤ / 1.5—Å">100 –ø–æ—Ç–æ–∫–æ–≤ / 1.5—Å</span>
      </button>
      <button class="spd-btn" data-t="3000" data-c="50" data-key="normal">
        <span class="spd-name">‚ñ∂ NORMAL</span>
        <span class="spd-info" data-en="50 threads / 3s" data-ru="50 –ø–æ—Ç–æ–∫–æ–≤ / 3—Å">50 –ø–æ—Ç–æ–∫–æ–≤ / 3—Å</span>
      </button>
      <button class="spd-btn" data-t="7000" data-c="20" data-key="safe">
        <span class="spd-name">üõ° SAFE</span>
        <span class="spd-info" data-en="20 threads / 7s" data-ru="20 –ø–æ—Ç–æ–∫–æ–≤ / 7—Å">20 –ø–æ—Ç–æ–∫–æ–≤ / 7—Å</span>
      </button>
    </div>
    <div class="fld">
      <span class="fld-lbl" data-en="Custom timeout (ms)" data-ru="–¢–∞–π–º–∞—É—Ç (–º—Å)">–¢–∞–π–º–∞—É—Ç (–º—Å)</span>
      <select id="timeoutSel">
        <option value="500">500 –º—Å</option>
        <option value="1000">1000 –º—Å</option>
        <option value="1500" selected>1500 –º—Å</option>
        <option value="3000">3000 –º—Å</option>
        <option value="5000">5000 –º—Å</option>
        <option value="7000">7000 –º—Å</option>
      </select>
    </div>
    <div class="fld">
      <span class="fld-lbl" data-en="Parallel threads" data-ru="–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤">–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤</span>
      <select id="concurrencySel">
        <option value="20">20</option>
        <option value="50">50</option>
        <option value="100" selected>100</option>
        <option value="150">150</option>
        <option value="200">200</option>
      </select>
    </div>
    <div class="spd-meter">
      <div class="spd-row">
        <span class="spd-label" data-en="Speed" data-ru="–°–∫–æ—Ä–æ—Å—Ç—å">–°–∫–æ—Ä–æ—Å—Ç—å</span>
        <span class="spd-val" id="spdVal">‚Äî ch/s</span>
      </div>
      <div class="spd-bar-bg"><div class="spd-bar-fill" id="spdBar"></div></div>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="sb-section">
    <div class="sb-label" data-en="Controls" data-ru="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
    <button class="btn btn-amber" id="btnCheck">‚ñ∂ <span data-en="Start Check" data-ru="–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É</span></button>
    <button class="btn btn-red"   id="btnStop"   disabled>‚ñ† <span data-en="Stop" data-ru="–°—Ç–æ–ø">–°—Ç–æ–ø</span></button>
    <button class="btn btn-cyan"  id="btnRefresh" disabled>‚Üª <span data-en="Refresh Status" data-ru="–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</span></button>
    <button class="btn btn-ghost" id="btnTest">üß™ <span data-en="Quick Test (3 random)" data-ru="–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (3 —Ä–∞–Ω–¥–æ–º–Ω—ã—Ö)">–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (3 —Ä–∞–Ω–¥–æ–º–Ω—ã—Ö)</span></button>
    <button class="btn btn-ghost" id="btnClear">‚úï <span data-en="Clear All" data-ru="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</span></button>
  </div>

  <!-- EXPORT -->
  <div class="sb-section">
    <div class="sb-label" data-en="Export" data-ru="–≠–∫—Å–ø–æ—Ä—Ç">–≠–∫—Å–ø–æ—Ä—Ç</div>
    <div class="fld">
      <span class="fld-lbl" data-en="Format" data-ru="–§–æ—Ä–º–∞—Ç">–§–æ—Ä–º–∞—Ç</span>
      <select id="exportFmt">
        <option value="m3u">M3U playlist</option>
        <option value="txt">TXT (M3U format)</option>
        <option value="json">JSON</option>
      </select>
    </div>
    <button class="btn btn-green" id="btnExport" disabled>‚¨á <span data-en="Download Working" data-ru="–°–∫–∞—á–∞—Ç—å —Ä–∞–±–æ—á–∏–µ">–°–∫–∞—á–∞—Ç—å —Ä–∞–±–æ—á–∏–µ</span></button>
    <button class="btn btn-ghost" id="btnPdf">üìÑ PDF <span data-en="Report" data-ru="–û—Ç—á—ë—Ç">–û—Ç—á—ë—Ç</span></button>

    <!-- BLOB LINK -->
    <div class="blob-panel" id="blobPanel">
      <span class="fld-lbl" data-en="Playlist link (for VLC/Kodi)" data-ru="–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–ª–µ–π–ª–∏—Å—Ç (–¥–ª—è VLC/Kodi)">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–ª–µ–π–ª–∏—Å—Ç (–¥–ª—è VLC/Kodi)</span>
      <a class="blob-url" id="blobLink" href="#" target="_blank">‚Äî</a>
      <button class="btn btn-ghost" id="btnCopyBlob" style="margin-bottom:5px;font-size:10px">üìã <span data-en="Copy Link" data-ru="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</span></button>
      <button class="btn btn-ghost" id="btnRevokeBlob" style="font-size:10px">‚úï <span data-en="Delete Link" data-ru="–£–¥–∞–ª–∏—Ç—å —Å—Å—ã–ª–∫—É">–£–¥–∞–ª–∏—Ç—å —Å—Å—ã–ª–∫—É</span></button>
    </div>
  </div>

  <!-- HISTORY -->
  <div class="sb-section">
    <div class="sb-label" data-en="History" data-ru="–ò—Å—Ç–æ—Ä–∏—è">–ò—Å—Ç–æ—Ä–∏—è</div>
    <ul class="mini-list" id="histList"></ul>
  </div>

  <!-- GROUPS -->
  <div class="sb-section">
    <div class="sb-label" data-en="Groups" data-ru="–ì—Ä—É–ø–ø—ã">–ì—Ä—É–ø–ø—ã</div>
    <ul class="mini-list" id="groupsList"></ul>
  </div>

</aside>

<!-- ‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê -->
<div class="main-panel">

  <!-- STATS + TIMER -->
  <div class="stats-bar">
    <div class="stat-item">
      <span class="stat-lbl" data-en="Total" data-ru="–í—Å–µ–≥–æ">–í—Å–µ–≥–æ</span>
      <span class="stat-val sv-total" id="sTot">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-lbl" data-en="Working" data-ru="–†–∞–±–æ—á–∏—Ö">–†–∞–±–æ—á–∏—Ö</span>
      <span class="stat-val sv-ok" id="sOk">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-lbl" data-en="Dead" data-ru="–ú—ë—Ä—Ç–≤—ã—Ö">–ú—ë—Ä—Ç–≤—ã—Ö</span>
      <span class="stat-val sv-dead" id="sDead">0</span>
    </div>
    <div class="stat-item" id="remItem" style="display:none">
      <span class="stat-lbl" data-en="Left" data-ru="–û—Å—Ç–∞–ª–æ—Å—å">–û—Å—Ç–∞–ª–æ—Å—å</span>
      <span class="stat-val sv-rem" id="sRem">0</span>
    </div>

    <div class="timer-wrap">
      <div class="timer-block">
        <span class="timer-label" data-en="Elapsed" data-ru="–ü—Ä–æ—à–ª–æ">–ü—Ä–æ—à–ª–æ</span>
        <span class="timer-digits" id="timerEl">00:00:00</span>
        <span class="eta-val" id="etaEl">‚Äî</span>
      </div>
      <button class="timer-info-btn" id="btnInfo" title="Info">i</button>
    </div>
  </div>

  <!-- PROGRESS -->
  <div class="prog-wrap" id="progWrap"><div class="prog-fill" id="progFill"></div></div>

  <!-- FILTER BAR -->
  <div class="filter-bar" id="filterBarEl">
    <button class="filter-chip on" data-st="all"         data-en="ALL"     data-ru="–í–°–ï">–í–°–ï</button>
    <button class="filter-chip"    data-st="Available"   data-en="‚úî LIVE"  data-ru="‚úî –†–ê–ë–û–ß–ò–ï">‚úî –†–ê–ë–û–ß–ò–ï</button>
    <button class="filter-chip"    data-st="Unavailable" data-en="‚úï DEAD"  data-ru="‚úï –ú–Å–†–¢–í–´–ï">‚úï –ú–Å–†–¢–í–´–ï</button>
    <input type="text" class="filter-search" id="srchIn" placeholder="üîç Search / –ü–æ–∏—Å–∫...">
  </div>

  <!-- PANE: RESULTS -->
  <div class="pane on" id="pane-results">
    <div class="tbl-scroll">
      <table>
        <thead><tr>
          <th class="td-logo">LOGO</th>
          <th style="min-width:140px" data-en="NAME" data-ru="–ù–ê–ó–í–ê–ù–ò–ï">–ù–ê–ó–í–ê–ù–ò–ï</th>
          <th style="min-width:100px" data-en="GROUP" data-ru="–ì–†–£–ü–ü–ê">–ì–†–£–ü–ü–ê</th>
          <th style="width:110px"     data-en="STATUS" data-ru="–°–¢–ê–¢–£–°">–°–¢–ê–¢–£–°</th>
          <th class="td-actions"      data-en="ACTIONS" data-ru="–î–ï–ô–°–¢–í–ò–Ø">–î–ï–ô–°–¢–í–ò–Ø</th>
        </tr></thead>
        <tbody id="resTbody"></tbody>
      </table>
    </div>
    <div class="pager">
      <button class="pg-btn" id="pgPrev">‚óÄ</button>
      <span class="pg-info" id="pgInfo">‚Äî / ‚Äî</span>
      <button class="pg-btn" id="pgNext">‚ñ∂</button>
      <select class="pg-size" id="pgSize">
        <option value="50">50</option>
        <option value="100" selected>100</option>
        <option value="250">250</option>
        <option value="500">500</option>
      </select>
      <span style="font-size:10px;color:var(--txt3)" id="pgCount"></span>
    </div>
  </div>

  <!-- PANE: FAVORITES -->
  <div class="pane" id="pane-favorites">
    <div class="tbl-scroll">
      <table>
        <thead><tr>
          <th class="td-logo">LOGO</th>
          <th data-en="NAME" data-ru="–ù–ê–ó–í–ê–ù–ò–ï">–ù–ê–ó–í–ê–ù–ò–ï</th>
          <th data-en="GROUP" data-ru="–ì–†–£–ü–ü–ê">–ì–†–£–ü–ü–ê</th>
          <th data-en="STATUS" data-ru="–°–¢–ê–¢–£–°">–°–¢–ê–¢–£–°</th>
          <th class="td-actions" data-en="ACTIONS" data-ru="–î–ï–ô–°–¢–í–ò–Ø">–î–ï–ô–°–¢–í–ò–Ø</th>
        </tr></thead>
        <tbody id="favTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- PANE: COMPARE -->
  <div class="pane" id="pane-compare">
    <div class="compare-area">
      <div class="fld">
        <span class="fld-lbl" data-en="Second Playlist File" data-ru="–í—Ç–æ—Ä–æ–π –ø–ª–µ–π–ª–∏—Å—Ç">–í—Ç–æ—Ä–æ–π –ø–ª–µ–π–ª–∏—Å—Ç</span>
        <input type="file" id="cmpFile" accept=".m3u,.m3u8,.txt,.json">
      </div>
      <button class="btn btn-cyan" id="btnCompare" style="width:auto">‚öñ <span data-en="Compare Playlists" data-ru="–°—Ä–∞–≤–Ω–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç—ã">–°—Ä–∞–≤–Ω–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç—ã</span></button>
      <div class="tbl-scroll" id="cmpWrap" style="display:none;max-height:55vh">
        <table>
          <thead><tr>
            <th data-en="NAME" data-ru="–ù–ê–ó–í–ê–ù–ò–ï">–ù–ê–ó–í–ê–ù–ò–ï</th>
            <th data-en="GROUP" data-ru="–ì–†–£–ü–ü–ê">–ì–†–£–ü–ü–ê</th>
            <th data-en="STATUS" data-ru="–°–¢–ê–¢–£–°">–°–¢–ê–¢–£–°</th>
            <th data-en="SOURCE" data-ru="–ò–°–¢–û–ß–ù–ò–ö">–ò–°–¢–û–ß–ù–ò–ö</th>
          </tr></thead>
          <tbody id="cmpTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div><!-- /main-panel -->
</div><!-- /app -->

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INDEX33 v4.0
   ‚Äî –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ (response.ok + ContentType)
   ‚Äî –°–µ–º–∞—Ñ–æ—Ä–Ω—ã–π –ø—É–ª (—Ä–µ–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å)
   ‚Äî –ú–∏–Ω–∏-–ø–ª–µ–µ—Ä (–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–π)
   ‚Äî –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç 3 —Ä–∞–Ω–¥–æ–º–Ω—ã—Ö
   ‚Äî –ö–Ω–æ–ø–∫–∞ Info —É —Ç–∞–π–º–µ—Ä–∞
   ‚Äî EN/RU
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

const DLOGO = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><rect width="28" height="28" rx="3" fill="%230b1018"/><text x="14" y="19" font-size="10" text-anchor="middle" fill="%232a3848" font-family="monospace">TV</text></svg>';

/* ‚îÄ‚îÄ STATE ‚îÄ‚îÄ */
let allResults  = [];
let filtCache   = [];
let favorites   = [];
let stopFlag    = false;
let hlsMini     = null;
let hlsFull     = null;
let curPage     = 1;
let pgSz        = 100;
let stFilter    = 'all';
let srchQ       = '';
let timerIv     = null;
let timerT0     = 0;
let spdIv       = null;
let lastDone    = 0;
let lang        = 'ru';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LANG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setLang(l) {
  lang = l;
  localStorage.setItem('i33_lang', l);
  document.querySelectorAll('[data-'+l+']').forEach(el => {
    if (el.tagName !== 'INPUT' && el.tagName !== 'BUTTON') {
      el.textContent = el.getAttribute('data-'+l);
    }
  });
  // chips
  document.querySelectorAll('.filter-chip[data-'+l+']').forEach(el => {
    el.textContent = el.getAttribute('data-'+l);
  });
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('on', b.dataset.lang === l));
  // placeholder search
  document.getElementById('srchIn').placeholder = l==='ru' ? 'üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é / –≥—Ä—É–ø–ø–µ...' : 'üîç Search by name / group...';
  // speed preset info
  document.querySelectorAll('.spd-btn .spd-info[data-'+l+']').forEach(el => {
    el.textContent = el.getAttribute('data-'+l);
  });
}

document.querySelectorAll('.lang-btn').forEach(b => {
  b.addEventListener('click', () => setLang(b.dataset.lang));
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.querySelectorAll('.hdr-tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.hdr-tab, .pane').forEach(e => e.classList.remove('on'));
    t.classList.add('on');
    const p = document.getElementById('pane-'+t.dataset.tab);
    if (p) p.classList.add('on');
    document.getElementById('filterBarEl').style.display =
      t.dataset.tab === 'results' ? 'flex' : 'none';
  });
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SPEED PRESETS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.querySelectorAll('.spd-btn').forEach(b => {
  b.addEventListener('click', () => {
    document.querySelectorAll('.spd-btn').forEach(x => x.classList.remove('on'));
    b.classList.add('on');
    document.getElementById('timeoutSel').value     = b.dataset.t;
    document.getElementById('concurrencySel').value = b.dataset.c;
  });
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TIMER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function pad(n) { return String(n).padStart(2,'0'); }

function startTimer() {
  timerT0 = Date.now();
  clearInterval(timerIv);
  timerIv = setInterval(() => {
    const s  = Math.floor((Date.now()-timerT0)/1000);
    document.getElementById('timerEl').textContent =
      `${pad(Math.floor(s/3600))}:${pad(Math.floor((s%3600)/60))}:${pad(s%60)}`;
    // ETA
    const done  = allResults.filter(r=>r.status!=='Checking').length;
    const total = allResults.length;
    if (done > 5 && total > done) {
      const rate = done / ((Date.now()-timerT0)/1000);
      const rem  = Math.ceil((total-done)/rate);
      document.getElementById('etaEl').textContent =
        `ETA ${pad(Math.floor(rem/60))}:${pad(rem%60)}`;
    }
  }, 1000);
}

function stopTimer() {
  clearInterval(timerIv);
  document.getElementById('etaEl').textContent = lang==='ru'?'‚úî –≥–æ—Ç–æ–≤–æ':'‚úî done';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SPEED METER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startSpd() {
  lastDone = 0;
  spdIv = setInterval(() => {
    const done = allResults.filter(r=>r.status!=='Checking').length;
    const delta = done - lastDone; lastDone = done;
    document.getElementById('spdVal').textContent = delta + ' ch/s';
    document.getElementById('spdBar').style.width = Math.min(100, delta/2)+'%';
  }, 1000);
}

function stopSpd() {
  clearInterval(spdIv);
  document.getElementById('spdVal').textContent = '‚Äî ch/s';
  document.getElementById('spdBar').style.width = '0%';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROGRESS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setProg(p) { document.getElementById('progFill').style.width = Math.min(100,p)+'%'; }
function showProg() { document.getElementById('progWrap').style.display='block'; }
function hideProg() { document.getElementById('progWrap').style.display='none'; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function modal(title, msg, type='inf', extraHtml='') {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalTitle').className   = 'modal-title mt-'+type;
  document.getElementById('modalMsg').textContent   = msg;
  document.getElementById('modalExtra').innerHTML   = extraHtml;
  document.getElementById('modal').classList.add('show');
}

document.getElementById('modalOk').addEventListener('click', () => {
  document.getElementById('modal').classList.remove('show');
  document.getElementById('modalExtra').innerHTML = '';
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INFO BUTTON ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.getElementById('btnInfo').addEventListener('click', () => {
  const ok   = allResults.filter(r=>r.status==='Available').length;
  const dead = allResults.filter(r=>r.status==='Unavailable').length;
  const rem  = allResults.length - ok - dead;
  const elapsed = document.getElementById('timerEl').textContent;
  const grps = new Set(allResults.map(r=>r.group)).size;
  const favs = favorites.length;
  const pct  = allResults.length ? Math.round(ok/allResults.length*100) : 0;
  const s = allResults.length ? Math.floor((Date.now()-timerT0)/1000) : 0;
  const rate = s > 0 ? Math.round(ok/s) : 0;

  const extra = `<div class="info-grid">
    <div class="info-cell"><div class="info-cell-lbl">${lang==='ru'?'–í—Å–µ–≥–æ':'Total'}</div><div class="info-cell-val" style="color:var(--cyan)">${allResults.length}</div></div>
    <div class="info-cell"><div class="info-cell-lbl">${lang==='ru'?'–†–∞–±–æ—á–∏—Ö':'Working'}</div><div class="info-cell-val" style="color:var(--green)">${ok}</div></div>
    <div class="info-cell"><div class="info-cell-lbl">${lang==='ru'?'–ú—ë—Ä—Ç–≤—ã—Ö':'Dead'}</div><div class="info-cell-val" style="color:var(--red)">${dead}</div></div>
    <div class="info-cell"><div class="info-cell-lbl">${lang==='ru'?'–û—Å—Ç–∞–ª–æ—Å—å':'Remaining'}</div><div class="info-cell-val" style="color:var(--amber)">${rem}</div></div>
    <div class="info-cell"><div class="info-cell-lbl">${lang==='ru'?'% –∂–∏–≤—ã—Ö':'% alive'}</div><div class="info-cell-val" style="color:var(--green)">${pct}%</div></div>
    <div class="info-cell"><div class="info-cell-lbl">${lang==='ru'?'–ò–∑–±—Ä–∞–Ω–Ω—ã—Ö':'Favorites'}</div><div class="info-cell-val" style="color:var(--amber)">${favs}</div></div>
    <div class="info-cell"><div class="info-cell-lbl">${lang==='ru'?'–ì—Ä—É–ø–ø':'Groups'}</div><div class="info-cell-val" style="color:var(--cyan)">${grps}</div></div>
    <div class="info-cell"><div class="info-cell-lbl">${lang==='ru'?'–°–∫–æ—Ä–æ—Å—Ç—å':'Rate'}</div><div class="info-cell-val" style="color:var(--amber)">${rate} ch/s</div></div>
  </div>`;

  modal('INDEX33 // INFO', `${lang==='ru'?'–í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏':'Check time'}: ${elapsed}`, 'amb', extra);
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PARSE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function detectType(name, content) {
  const e = (name||'').split('.').pop().toLowerCase();
  if (e==='json') return 'JSON';
  const t = (content||'').trimStart();
  if (t.startsWith('{')||t.startsWith('[')) return 'JSON';
  return 'M3U';
}

function parseM3U(content) {
  const links = [];
  const lines = content.split(/\r?\n/);
  let cur = { name:'‚Äî', group:'‚Äî', logo:DLOGO };
  for (let i=0;i<lines.length;i++) {
    const ln = lines[i].trim();
    if (!ln) continue;
    if (ln.startsWith('#EXTINF:')) {
      const nm  = ln.match(/tvg-name="([^"]*)"/);
      const grp = ln.match(/group-title="([^"]*)"/);
      const lg  = ln.match(/tvg-logo="([^"]*)"/);
      const cm  = ln.match(/,(.+)$/);
      cur = {
        name:  (nm?nm[1]:cm?cm[1]:'').trim()||'‚Äî',
        group: grp?grp[1].trim():'‚Äî',
        logo:  lg?lg[1].trim():DLOGO
      };
    } else if (!ln.startsWith('#') && (ln.startsWith('http')||ln.startsWith('rtmp')||ln.startsWith('rtsp'))) {
      links.push({...cur, host:ln, status:'Checking'});
      cur = {name:'‚Äî',group:'‚Äî',logo:DLOGO};
    }
  }
  return links;
}

function parseJSON(content) {
  let data; try{data=JSON.parse(content)}catch{return[]}
  if(!Array.isArray(data)) data=[data];
  return data.map(i=>({
    name:i.name||i.title||'‚Äî', group:i.group||i.type||'‚Äî',
    host:i.url||i.host||'', logo:i.img||i.logo||DLOGO, status:'Checking'
  })).filter(i=>i.host);
}

function parseInput(content,type){ return type==='JSON'?parseJSON(content):parseM3U(content); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHECK LINK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   –û–†–ò–ì–ò–ù–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê ‚Äî response.ok + ContentType
   GET + Range:bytes=0-1023
   –ù–ï –ú–ï–ù–Ø–¢–¨
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function checkLink(url) {
  try {
    const timeout = parseInt(document.getElementById('timeoutSel').value) || 5000;
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeout);

    const response = await fetch(url, {
      signal: controller.signal,
      method: 'GET',
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
        'Accept': 'video/mp4,video/x-matroska,application/vnd.apple.mpegurl,*/*',
        'Range': 'bytes=0-1023'
      },
      cache: 'no-store'
    });

    clearTimeout(timeoutId);

    const contentType = response.headers.get('Content-Type') || '';
    const isPlayable = response.ok && (
      contentType.includes('video') ||
      contentType.includes('application/vnd.apple.mpegurl') ||
      contentType.includes('application/octet-stream')
    );

    return isPlayable;
  } catch (error) {
    return false;
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê POOL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   –°–µ–º–∞—Ñ–æ—Ä–Ω—ã–π –ø—É–ª ‚Äî –∫–∞–∂–¥—ã–π –≤–æ—Ä–∫–µ—Ä
   –±–µ—Ä—ë—Ç —Å–ª–µ–¥—É—é—â—É—é –∑–∞–¥–∞—á—É —Å–∞–º –∫–∞–∫ —Ç–æ–ª—å–∫–æ —Å–≤–æ–±–æ–¥–µ–Ω
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function runPool(items, concurrency, fn) {
  let idx = 0;
  async function worker() {
    while (idx < items.length && !stopFlag) {
      const i = idx++;
      await fn(items[i], i);
    }
  }
  const ws = [];
  for (let w=0; w<Math.min(concurrency,items.length); w++) ws.push(worker());
  await Promise.all(ws);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROCESS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function processLinks(data) {
  allResults = data;
  filtCache  = [];
  curPage    = 1;
  updateStats();

  const conc  = parseInt(document.getElementById('concurrencySel').value)||100;
  const total = allResults.length;
  let uiT     = Date.now();

  await runPool(allResults, conc, async (item, i) => {
    allResults[i].status = await checkLink(item.host) ? 'Available' : 'Unavailable';
    const now = Date.now();
    if (now - uiT > 250) {
      uiT = now;
      const done = allResults.filter(r=>r.status!=='Checking').length;
      setProg((done/total)*100);
      updateStats();
      if (document.getElementById('pane-results').classList.contains('on')) {
        rebuildFilter(); renderPage();
      }
    }
  });

  rebuildFilter(); updateStats(); renderPage(); updateGroups(); saveStore();
  return allResults.filter(r=>r.status==='Available').length;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateStats() {
  const ok   = allResults.filter(r=>r.status==='Available').length;
  const dead = allResults.filter(r=>r.status==='Unavailable').length;
  const rem  = allResults.length - ok - dead;
  document.getElementById('sTot').textContent  = allResults.length;
  document.getElementById('sOk').textContent   = ok;
  document.getElementById('sDead').textContent = dead;
  document.getElementById('sRem').textContent  = rem;
  document.getElementById('remItem').style.display = rem>0?'':'none';
  document.getElementById('btnExport').disabled = ok===0;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FILTER + RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function rebuildFilter() {
  const q = srchQ.toLowerCase().trim();
  filtCache = allResults.filter(r => {
    if (stFilter!=='all' && r.status!==stFilter) return false;
    if (q && !r.name.toLowerCase().includes(q) && !r.group.toLowerCase().includes(q)) return false;
    return true;
  });
}

function E(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

function renderPage() {
  const total = filtCache.length;
  const pages = Math.max(1, Math.ceil(total/pgSz));
  if (curPage>pages) curPage=pages;
  const sl = filtCache.slice((curPage-1)*pgSz, curPage*pgSz);

  let html='';
  for (const r of sl) {
    const fav = favorites.some(f=>f.host===r.host);
    const stBadge = r.status==='Available'
      ? `<span class="badge b-ok">‚óè ${lang==='ru'?'–†–ê–ë–û–ß–ò–ô':'LIVE'}</span>`
      : r.status==='Unavailable'
      ? `<span class="badge b-err">‚úï ${lang==='ru'?'–ú–Å–†–¢–í–´–ô':'DEAD'}</span>`
      : `<span class="badge b-chk">‚ü≥ ${lang==='ru'?'–ü–†–û–í–ï–†–ö–ê':'CHECK'}</span>`;

    const acts = r.status==='Available'
      ? `<div class="act-btns">
          <button class="act-btn ab-play" title="${lang==='ru'?'–°–º–æ—Ç—Ä–µ—Ç—å':'Watch'}"  onclick="openMini('${E(r.host)}','${E(r.name)}')">‚ñ∂</button>
          <button class="act-btn ab-ext"  title="${lang==='ru'?'–í–Ω–µ—à–Ω–∏–π –ø–ª–µ–µ—Ä':'External player'}" onclick="openExtUrl('${E(r.host)}')">‚Üó</button>
          <button class="act-btn ab-fav ${fav?'on':''}" title="${lang==='ru'?'–ò–∑–±—Ä–∞–Ω–Ω–æ–µ':'Favorite'}" onclick="toggleFav('${E(r.host)}')">‚òÖ</button>
        </div>`
      : '';

    html += `<tr>
      <td class="td-logo"><img class="ch-logo" src="${E(r.logo)}" onerror="this.src='${DLOGO}'" loading="lazy"></td>
      <td title="${E(r.name)}">${E(r.name)}</td>
      <td title="${E(r.group)}" style="color:var(--txt2)">${E(r.group)}</td>
      <td>${stBadge}</td>
      <td class="td-actions">${acts}</td>
    </tr>`;
  }

  document.getElementById('resTbody').innerHTML = html;
  document.getElementById('pgInfo').textContent = `${curPage} / ${pages}`;
  document.getElementById('pgCount').textContent= `${total} / ${allResults.length}`;
  document.getElementById('pgPrev').disabled = curPage<=1;
  document.getElementById('pgNext').disabled = curPage>=pages;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.getElementById('pgPrev').addEventListener('click',()=>{curPage--;renderPage();});
document.getElementById('pgNext').addEventListener('click',()=>{curPage++;renderPage();});
document.getElementById('pgSize').addEventListener('change',e=>{pgSz=parseInt(e.target.value);curPage=1;renderPage();});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FILTERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.querySelectorAll('.filter-chip').forEach(c=>{
  c.addEventListener('click',()=>{
    document.querySelectorAll('.filter-chip').forEach(x=>x.classList.remove('on'));
    c.classList.add('on');
    stFilter=c.dataset.st; curPage=1; rebuildFilter(); renderPage();
  });
});

document.getElementById('srchIn').addEventListener('input',e=>{
  srchQ=e.target.value; curPage=1; rebuildFilter(); renderPage();
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FAVORITES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggleFav(host) {
  const r = allResults.find(r=>r.host===host); if(!r) return;
  const idx = favorites.findIndex(f=>f.host===host);
  if(idx===-1) favorites.push(r); else favorites.splice(idx,1);
  localStorage.setItem('i33_fav',JSON.stringify(favorites));
  rebuildFilter(); renderPage(); renderFav();
}
window.toggleFav = toggleFav;

function renderFav() {
  let html='';
  for(const r of favorites){
    html+=`<tr>
      <td class="td-logo"><img class="ch-logo" src="${E(r.logo)}" onerror="this.src='${DLOGO}'" loading="lazy"></td>
      <td title="${E(r.name)}">${E(r.name)}</td>
      <td style="color:var(--txt2)">${E(r.group)}</td>
      <td><span class="badge b-ok">‚óè ${lang==='ru'?'–†–ê–ë–û–ß–ò–ô':'LIVE'}</span></td>
      <td class="td-actions"><div class="act-btns">
        <button class="act-btn ab-play" onclick="openMini('${E(r.host)}','${E(r.name)}')">‚ñ∂</button>
        <button class="act-btn ab-ext"  onclick="openExtUrl('${E(r.host)}')">‚Üó</button>
        <button class="act-btn ab-fav on" onclick="toggleFav('${E(r.host)}')">‚òÖ</button>
      </div></td>
    </tr>`;
  }
  document.getElementById('favTbody').innerHTML = html;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GROUPS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateGroups() {
  const grps = [...new Set(allResults.map(r=>r.group||'‚Äî'))].sort();
  document.getElementById('groupsList').innerHTML =
    grps.map(g=>`<li onclick="filterByGroup('${E(g)}')">${E(g)}</li>`).join('');
}

function filterByGroup(g) {
  document.getElementById('srchIn').value = g; srchQ = g;
  stFilter='all';
  document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('on'));
  document.querySelector('[data-st="all"]').classList.add('on');
  curPage=1; rebuildFilter(); renderPage();
  document.querySelector('[data-tab="results"]').click();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HISTORY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function saveHist(name, total, ok) {
  const h=JSON.parse(localStorage.getItem('i33_hist')||'[]');
  h.unshift({name,total,ok,date:Date.now()});
  localStorage.setItem('i33_hist',JSON.stringify(h.slice(0,15)));
  renderHist();
}

function renderHist() {
  const h=JSON.parse(localStorage.getItem('i33_hist')||'[]');
  document.getElementById('histList').innerHTML=h.map(i=>{
    const nm=i.name.length>26?i.name.slice(0,26)+'‚Ä¶':i.name;
    const d=new Date(i.date).toLocaleString(lang==='ru'?'ru-RU':'en-US',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
    return `<li>${E(nm)} ‚Äî ${i.ok}/${i.total} [${d}]</li>`;
  }).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STORAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function saveStore() {
  try {
    localStorage.setItem('i33_res',JSON.stringify(
      allResults.map(r=>({n:r.name,g:r.group,h:r.host,l:r.logo,s:r.status}))
    ));
  } catch {}
}

function loadStore() {
  try {
    const raw=localStorage.getItem('i33_res');
    if(raw){
      allResults=JSON.parse(raw).map(r=>({name:r.n,group:r.g,host:r.h,logo:r.l,status:r.s}));
      rebuildFilter(); updateStats(); updateGroups(); renderPage();
    }
    const f=localStorage.getItem('i33_fav');
    if(f){favorites=JSON.parse(f);renderFav();}
  } catch {}
  renderHist();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê READ FILE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function readFile(file) {
  return new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=e=>res(e.target.result);
    fr.onerror=()=>rej(new Error(lang==='ru'?'–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞':'File read error'));
    fr.readAsText(file,'UTF-8');
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê START CHECK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.getElementById('btnCheck').addEventListener('click', async () => {
  const fi  = document.getElementById('fileInput');
  const url = document.getElementById('m3uUrl').value.trim();

  stopFlag=false;
  document.getElementById('btnCheck').disabled   = true;
  document.getElementById('btnStop').disabled    = false;
  document.getElementById('btnRefresh').disabled = true;
  showProg(); setProg(0); startTimer(); startSpd();

  try {
    let content='', name='', type='';

    if (fi.files.length) {
      name    = fi.files[0].name;
      setProg(2);
      content = await readFile(fi.files[0]);
      type    = detectType(name, content);
    } else if (url) {
      name = url.split('/').pop().split('?')[0] || 'playlist';
      setProg(2);
      const ac=new AbortController();
      const ti=setTimeout(()=>ac.abort(),90000);
      const resp=await fetch(url,{signal:ac.signal,headers:{'User-Agent':'Mozilla/5.0'}});
      clearTimeout(ti);
      if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
      content=await resp.text();
      type=detectType(url,content);
    } else {
      throw new Error(lang==='ru'?'–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ URL':'Select file or enter URL');
    }

    if(!content.trim()) throw new Error(lang==='ru'?'–§–∞–π–ª –ø—É—Å—Ç–æ–π':'File is empty');
    setProg(5);
    await new Promise(r=>setTimeout(r,0));

    const links = parseInput(content, type);
    if(!links.length) throw new Error(lang==='ru'?'–°—Å—ã–ª–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã':'No links found');

    // –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
    const seen=new Set();
    const uniq=links.filter(l=>{ if(seen.has(l.host))return false; seen.add(l.host); return true; });
    const dupes=links.length-uniq.length;

    setProg(8);
    const ok = await processLinks(uniq);
    const el = ((Date.now()-timerT0)/1000).toFixed(0);

    saveHist(name, uniq.length, ok);
    stopTimer(); stopSpd();

    modal(
      lang==='ru'?'‚úî –ì–û–¢–û–í–û':'‚úî DONE',
      `${lang==='ru'?'–†–∞–±–æ—á–∏—Ö':'Working'}: ${ok} / ${uniq.length}\n${lang==='ru'?'–î—É–±–ª–µ–π —É–¥–∞–ª–µ–Ω–æ':'Dupes removed'}: ${dupes}\n${lang==='ru'?'–í—Ä–µ–º—è':'Time'}: ${pad(Math.floor(el/60))}:${pad(el%60)}`,
      'ok'
    );
  } catch(e) {
    stopTimer(); stopSpd();
    modal(lang==='ru'?'‚úï –û–®–ò–ë–ö–ê':'‚úï ERROR', e.message, 'err');
    console.error(e);
  } finally {
    document.getElementById('btnCheck').disabled   = false;
    document.getElementById('btnStop').disabled    = true;
    document.getElementById('btnRefresh').disabled = false;
    hideProg();
  }
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STOP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.getElementById('btnStop').addEventListener('click',()=>{
  stopFlag=true; stopTimer(); stopSpd(); hideProg();
  document.getElementById('btnStop').disabled=true;
  rebuildFilter(); renderPage();
  const done=allResults.filter(r=>r.status!=='Checking').length;
  modal(
    lang==='ru'?'‚ñ† –°–¢–û–ü':'‚ñ† STOPPED',
    `${lang==='ru'?'–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ':'Checked'}: ${done} / ${allResults.length}\n${lang==='ru'?'–†–∞–±–æ—á–∏—Ö':'Working'}: ${allResults.filter(r=>r.status==='Available').length}`,
    'inf'
  );
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REFRESH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.getElementById('btnRefresh').addEventListener('click', async ()=>{
  if(!allResults.length){modal(lang==='ru'?'–û–®–ò–ë–ö–ê':'ERROR',lang==='ru'?'–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö':'No data','err');return;}
  stopFlag=false;
  allResults.forEach(r=>r.status='Checking');
  document.getElementById('btnRefresh').disabled=true;
  document.getElementById('btnStop').disabled=false;
  showProg(); startTimer(); startSpd();

  const conc=parseInt(document.getElementById('concurrencySel').value)||100;
  let uiT=Date.now();
  await runPool(allResults,conc,async(item,i)=>{
    allResults[i].status=await checkLink(item.host)?'Available':'Unavailable';
    const now=Date.now();
    if(now-uiT>250){uiT=now;setProg(allResults.filter(r=>r.status!=='Checking').length/allResults.length*100);updateStats();}
  });

  rebuildFilter(); updateStats(); renderPage(); saveStore();
  stopTimer(); stopSpd(); hideProg();
  document.getElementById('btnRefresh').disabled=false;
  document.getElementById('btnStop').disabled=true;
  modal(
    lang==='ru'?'‚úî –û–ë–ù–û–í–õ–ï–ù–û':'‚úî REFRESHED',
    `${lang==='ru'?'–†–∞–±–æ—á–∏—Ö':'Working'}: ${allResults.filter(r=>r.status==='Available').length} / ${allResults.length}`,
    'ok'
  );
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CLEAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.getElementById('btnClear').addEventListener('click',()=>{
  allResults=[];filtCache=[];favorites=[];
  ['i33_res','i33_fav','i33_hist'].forEach(k=>localStorage.removeItem(k));
  updateStats();rebuildFilter();renderPage();renderFav();updateGroups();renderHist();
  document.getElementById('btnExport').disabled=true;
  document.getElementById('timerEl').textContent='00:00:00';
  document.getElementById('etaEl').textContent='‚Äî';
  document.getElementById('blobPanel').style.display='none';
  hideProg();
  if(window._blobUrl){URL.revokeObjectURL(window._blobUrl);window._blobUrl=null;}
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê QUICK TEST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.getElementById('btnTest').addEventListener('click', async ()=>{
  const pool = allResults.filter(r=>r.status==='Available');
  if(pool.length < 1){
    modal(
      lang==='ru'?'–¢–ï–°–¢':'TEST',
      lang==='ru'?'–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É ‚Äî –Ω–µ—Ç —Ä–∞–±–æ—á–∏—Ö –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∞.':'Run check first ‚Äî no working channels to test.',
      'inf'
    );
    return;
  }

  // –ë–µ—Ä—ë–º 3 —Ä–∞–Ω–¥–æ–º–Ω—ã—Ö —Ä–∞–±–æ—á–∏—Ö –∫–∞–Ω–∞–ª–∞
  const shuffled = [...pool].sort(()=>Math.random()-.5).slice(0,3);

  const rows = shuffled.map(r=>`
    <div class="test-ch-row">
      <span class="test-ch-name">${E(r.name)}</span>
      <span class="test-ch-st" id="tst_${E(r.host.slice(-16))}" style="color:var(--amber)">‚ü≥</span>
      <button class="act-btn ab-play" onclick="openMini('${E(r.host)}','${E(r.name)}');document.getElementById('modal').classList.remove('show')" style="flex-shrink:0">‚ñ∂</button>
    </div>`).join('');

  modal(
    lang==='ru'?'üß™ –ë–´–°–¢–†–´–ô –¢–ï–°–¢':'üß™ QUICK TEST',
    lang==='ru'?'3 —Å–ª—É—á–∞–π–Ω—ã—Ö —Ä–∞–±–æ—á–∏—Ö –∫–∞–Ω–∞–ª–∞.\n–ù–∞–∂–º–∏ ‚ñ∂ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –≤ –º–∏–Ω–∏-–ø–ª–µ–µ—Ä–µ:':'3 random working channels.\nPress ‚ñ∂ to open in mini player:',
    'amb',
    `<div class="test-channels">${rows}</div>`
  );
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.getElementById('btnExport').addEventListener('click',()=>{
  const fmt  = document.getElementById('exportFmt').value;
  const avail= allResults.filter(r=>r.status==='Available');
  if(!avail.length){modal(lang==='ru'?'–û–®–ò–ë–ö–ê':'ERROR',lang==='ru'?'–ù–µ—Ç —Ä–∞–±–æ—á–∏—Ö':'No working channels','err');return;}

  let content, filename, mime;
  if(fmt==='m3u'||fmt==='txt'){
    const parts=['#EXTM3U\n'];
    for(const r of avail)
      parts.push(`#EXTINF:-1 tvg-logo="${r.logo||''}" group-title="${r.group||''}",${r.name||''}\n${r.host}\n`);
    content=parts.join('');
    filename=fmt==='m3u'?'index33_playlist.m3u':'index33_links.txt';
    mime='application/x-mpegurl';
  } else {
    content=JSON.stringify(avail.map(r=>({name:r.name,type:r.group,url:r.host,img:r.logo})),null,2);
    filename='index33_links.json'; mime='application/json';
  }

  const blob=new Blob([content],{type:mime});
  const blobUrl=URL.createObjectURL(blob);

  // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
  const a=Object.assign(document.createElement('a'),{href:blobUrl,download:filename,style:'display:none'});
  document.body.appendChild(a); a.click(); document.body.removeChild(a);

  // Blob —Å—Å—ã–ª–∫–∞ –¥–ª—è VLC/Kodi
  if(window._blobUrl) URL.revokeObjectURL(window._blobUrl);
  window._blobUrl = blobUrl;
  document.getElementById('blobPanel').style.display='block';
  document.getElementById('blobLink').href=blobUrl;
  document.getElementById('blobLink').textContent=blobUrl;

  modal(
    lang==='ru'?'‚¨á –≠–ö–°–ü–û–†–¢':'‚¨á EXPORT',
    `${filename}\n${avail.length} ${lang==='ru'?'—Ä–∞–±–æ—á–∏—Ö –∫–∞–Ω–∞–ª–æ–≤':'working channels'}\n\n${lang==='ru'?'Blob-—Å—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ ‚Äî –≤—Å—Ç–∞–≤—å –≤ VLC ‚Üí –ú–µ–¥–∏–∞ ‚Üí –û—Ç–∫—Ä—ã—Ç—å URL':'Blob link ready ‚Äî paste in VLC ‚Üí Media ‚Üí Open URL'}`,
    'ok'
  );
});

document.getElementById('btnCopyBlob').addEventListener('click',()=>{
  const url=document.getElementById('blobLink').href;
  if(!url||url==='#') return;
  navigator.clipboard.writeText(url).then(()=>{
    modal(lang==='ru'?'üìã –°–ö–û–ü–ò–†–û–í–ê–ù–û':'üìã COPIED',lang==='ru'?'–°—Å—ã–ª–∫–∞ –≤ –±—É—Ñ–µ—Ä–µ.\n–í—Å—Ç–∞–≤—å –≤ VLC: –ú–µ–¥–∏–∞ ‚Üí –û—Ç–∫—Ä—ã—Ç—å URL':'Link copied.\nPaste in VLC: Media ‚Üí Open URL','ok');
  }).catch(()=>{
    const ta=Object.assign(document.createElement('textarea'),{value:url,style:'position:fixed;opacity:0'});
    document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    modal(lang==='ru'?'üìã –°–ö–û–ü–ò–†–û–í–ê–ù–û':'üìã COPIED',lang==='ru'?'–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!':'Copied!','ok');
  });
});

document.getElementById('btnRevokeBlob').addEventListener('click',()=>{
  if(window._blobUrl){URL.revokeObjectURL(window._blobUrl);window._blobUrl=null;}
  document.getElementById('blobPanel').style.display='none';
  document.getElementById('blobLink').href='#';
  document.getElementById('blobLink').textContent='‚Äî';
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PDF ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.getElementById('btnPdf').addEventListener('click',()=>{
  if(typeof window.jspdf==='undefined'){modal('ERROR','jsPDF not loaded','err');return;}
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  const ok=allResults.filter(r=>r.status==='Available').length;
  const tot=allResults.length;
  doc.setFont('helvetica','bold'); doc.setFontSize(22);
  doc.text('INDEX33 // IPTV REPORT',10,20);
  doc.setFont('helvetica','normal'); doc.setFontSize(12);
  doc.text(`Date: ${new Date().toLocaleString()}`,10,35);
  doc.text(`Time elapsed: ${document.getElementById('timerEl').textContent}`,10,45);
  doc.text(`Total: ${tot}`,10,55);
  doc.text(`Working: ${ok}`,10,65);
  doc.text(`Dead: ${tot-ok}`,10,75);
  doc.text(`Favorites: ${favorites.length}`,10,85);
  doc.text(`Groups: ${[...new Set(allResults.map(r=>r.group))].length}`,10,95);
  doc.save('index33_report.pdf');
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMPARE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.getElementById('btnCompare').addEventListener('click', async ()=>{
  const fi=document.getElementById('cmpFile');
  if(!fi.files.length||!allResults.length){
    modal(lang==='ru'?'–û–®–ò–ë–ö–ê':'ERROR',lang==='ru'?'–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–π–ª–∏—Å—Ç –∏ –≤—Ç–æ—Ä–æ–π —Ñ–∞–π–ª':'Load main playlist and second file first','err');
    return;
  }
  const content=await readFile(fi.files[0]);
  const type=detectType(fi.files[0].name,content);
  const second=parseInput(content,type);
  const firstSet=new Set(allResults.map(r=>r.host));
  let html='';
  for(const r of second){
    const dup=firstSet.has(r.host);
    html+=`<tr>
      <td title="${E(r.name)}">${E(r.name)}</td>
      <td style="color:var(--txt2)">${E(r.group)}</td>
      <td><span class="badge ${dup?'b-chk':'b-ok'}">${dup?(lang==='ru'?'–î–£–ë–õ–ò–ö–ê–¢':'DUPLICATE'):(lang==='ru'?'–£–ù–ò–ö–ê–õ–¨–ù–´–ô':'UNIQUE')}</span></td>
      <td style="color:var(--txt2)">${lang==='ru'?'2-–π –ø–ª–µ–π–ª–∏—Å—Ç':'2nd playlist'}</td>
    </tr>`;
  }
  document.getElementById('cmpTbody').innerHTML=html;
  document.getElementById('cmpWrap').style.display='block';
  modal(
    lang==='ru'?'‚öñ –°–†–ê–í–ù–ï–ù–ò–ï':'‚öñ COMPARE',
    `${lang==='ru'?'–ü–µ—Ä–≤—ã–π':'First'}: ${allResults.length}\n${lang==='ru'?'–í—Ç–æ—Ä–æ–π':'Second'}: ${second.length}\n${lang==='ru'?'–î—É–±–ª–µ–π':'Dupes'}: ${second.filter(r=>firstSet.has(r.host)).length}\n${lang==='ru'?'–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö':'Unique'}: ${second.filter(r=>!firstSet.has(r.host)).length}`,
    'inf'
  );
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   –ú–ò–ù–ò-–ü–õ–ï–ï–†
   –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–π, HLS –ø–æ–¥–¥–µ—Ä–∂–∫–∞
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let miniHlsInst = null;

function openMini(url, name) {
  const box   = document.getElementById('miniPlayer');
  const video = document.getElementById('miniVideo');
  const st    = document.getElementById('miniStatus');
  const title = document.getElementById('miniTitle');

  // –°—Ç–æ–ø –ø—Ä–µ–¥—ã–¥—É—â–∏–π
  video.pause();
  if(miniHlsInst){miniHlsInst.destroy();miniHlsInst=null;}
  video.src=''; video.load();

  title.textContent = name||url;
  st.className='mini-status load';
  st.textContent = lang==='ru'?'–ó–∞–≥—Ä—É–∑–∫–∞...':'Loading...';
  box.classList.add('show');

  const isHLS = url.includes('.m3u8');

  if(isHLS && typeof Hls!=='undefined' && Hls.isSupported()){
    miniHlsInst=new Hls({enableWorker:true,lowLatencyMode:true});
    miniHlsInst.loadSource(url);
    miniHlsInst.attachMedia(video);
    miniHlsInst.on(Hls.Events.MANIFEST_PARSED,()=>{
      st.className='mini-status ok';
      st.textContent=lang==='ru'?'‚úî –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è':'‚úî Playing';
      video.play().catch(()=>{});
    });
    miniHlsInst.on(Hls.Events.ERROR,(_,d)=>{
      if(d.fatal){
        st.className='mini-status err';
        st.textContent=lang==='ru'?'‚úï –û—à–∏–±–∫–∞ –ø–æ—Ç–æ–∫–∞':'‚úï Stream error';
        miniHlsInst.destroy(); miniHlsInst=null;
      }
    });
  } else {
    video.src=url;
    video.oncanplay=()=>{
      st.className='mini-status ok';
      st.textContent=lang==='ru'?'‚úî –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è':'‚úî Playing';
    };
    video.onerror=()=>{
      st.className='mini-status err';
      st.textContent=lang==='ru'?'‚úï –ù–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è':'‚úï Cannot play';
    };
    video.play().catch(()=>{});
  }
}

window.openMini = openMini;

document.getElementById('miniClose').addEventListener('click',()=>{
  const video=document.getElementById('miniVideo');
  video.pause();
  if(miniHlsInst){miniHlsInst.destroy();miniHlsInst=null;}
  video.src='';
  document.getElementById('miniPlayer').classList.remove('show');
});

document.getElementById('miniExpand').addEventListener('click',()=>{
  const video=document.getElementById('miniVideo');
  const src=video.src||'';
  const name=document.getElementById('miniTitle').textContent;
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–∏–Ω–∏, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–π
  video.pause();
  if(miniHlsInst){miniHlsInst.destroy();miniHlsInst=null;}
  video.src='';
  document.getElementById('miniPlayer').classList.remove('show');
  openFull(src,name);
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FULL PLAYER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let fullHlsInst = null;

function openFull(url, name) {
  const box   = document.getElementById('fullPlayer');
  const video = document.getElementById('fullVideo');
  document.getElementById('fpTitle').textContent = name||url;
  video.pause();
  if(fullHlsInst){fullHlsInst.destroy();fullHlsInst=null;}
  video.src=''; video.load();

  if(url.includes('.m3u8') && typeof Hls!=='undefined' && Hls.isSupported()){
    fullHlsInst=new Hls({enableWorker:true,lowLatencyMode:true});
    fullHlsInst.loadSource(url); fullHlsInst.attachMedia(video);
    fullHlsInst.on(Hls.Events.MANIFEST_PARSED,()=>{box.classList.add('show');video.play().catch(()=>{});});
    fullHlsInst.on(Hls.Events.ERROR,(_,d)=>{
      if(d.fatal){fullHlsInst.destroy();fullHlsInst=null;box.classList.remove('show');}
    });
  } else {
    video.src=url; box.classList.add('show');
    video.play().catch(()=>{});
  }
}

document.getElementById('fpClose').addEventListener('click',()=>{
  const video=document.getElementById('fullVideo');
  video.pause();
  if(fullHlsInst){fullHlsInst.destroy();fullHlsInst=null;}
  video.src='';
  document.getElementById('fullPlayer').classList.remove('show');
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXTERNAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openExtUrl(url){ window.open(url,'_blank'); }
window.openExtUrl=openExtUrl;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DRAG MINI PLAYER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(function(){
  const box = document.getElementById('miniPlayer');
  const hdr = document.getElementById('miniDragHdr');
  let ox=0,oy=0,bx=0,by=0,dragging=false;

  hdr.addEventListener('mousedown',e=>{
    if(e.target.closest('.mini-btn')) return;
    dragging=true;
    ox=e.clientX; oy=e.clientY;
    const rect=box.getBoundingClientRect();
    bx=rect.left; by=rect.top;
    box.style.transition='none';
    e.preventDefault();
  });

  document.addEventListener('mousemove',e=>{
    if(!dragging) return;
    const dx=e.clientX-ox; const dy=e.clientY-oy;
    box.style.right='auto'; box.style.bottom='auto';
    box.style.left=Math.max(0,bx+dx)+'px';
    box.style.top =Math.max(0,by+dy)+'px';
  });

  document.addEventListener('mouseup',()=>{ dragging=false; });

  // Touch
  hdr.addEventListener('touchstart',e=>{
    if(e.target.closest('.mini-btn')) return;
    const t=e.touches[0];
    dragging=true; ox=t.clientX; oy=t.clientY;
    const rect=box.getBoundingClientRect(); bx=rect.left; by=rect.top;
    box.style.transition='none';
  },{passive:true});

  document.addEventListener('touchmove',e=>{
    if(!dragging) return;
    const t=e.touches[0];
    const dx=t.clientX-ox; const dy=t.clientY-oy;
    box.style.right='auto'; box.style.bottom='auto';
    box.style.left=Math.max(0,bx+dx)+'px';
    box.style.top =Math.max(0,by+dy)+'px';
  },{passive:true});

  document.addEventListener('touchend',()=>{ dragging=false; });
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(function(){
  lang = localStorage.getItem('i33_lang') || 'ru';
  setLang(lang);
  loadStore();
})();
</script>
</body>
</html>
     
